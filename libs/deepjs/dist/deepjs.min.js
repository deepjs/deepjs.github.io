/**
 *
 * @author Gilles Coomans <gilles.coomans@gmail.com>
 * Promise classe and related tools.
 * Inspired from [promised-io](https://github.com/kriszyp/promised-io) from Kris Zyp implementation.
 * @licence
 * The MIT License (MIT)
 * Copyright (c) 2015 Gilles Coomans
 */

/**
 * @author Gilles Coomans <gilles.coomans@gmail.com>
 * deep-protocols :	Abstract Ressource Locator and dependencies manager.
 * @licence
 * The MIT License (MIT)
 * Copyright (c) 2015 Gilles Coomans
 */

define("deep-utils/index",[],function(){var e={};e.toPath=function(e,t,n,r,i){if(t[0]=="/"||t.substring(0,1)=="./")r="/";var s=t.split(r||".");r=="/"&&(s[0]===""||s[0]==".")&&s.shift();var o=e;while(s.length>1){var u=s.shift();o[u]||(o[u]={}),o=o[u]}var a=s.shift();return i&&o[a]?(o[a].forEach||(o[a]=[o[a]]),o[a].push(n)):o[a]=n,n},e.fromPath=function(e,t,n){if(!t)return e;if(t[0]=="/"||t.substring(0,1)=="./")n="/";var r=t.split(n||".");n=="/"&&(r[0]===""||r[0]==".")&&r.shift();var i=e;while(r.length>1){var s=r.shift();if(!i[s])return undefined;i=i[s]}return i?i[r.shift()]:undefined},e.deletePropertyByPath=function(e,t,n){if(t[0]=="/"||t.substring(0,1)=="./")n="/";var r=t.split(n||".");n=="/"&&(r[0]===""||r[0]==".")&&r.shift();var i=e;while(r.length>1){var s=r.shift();if(!i[s])return;i=i[s]}delete i[r.shift()]},e.cloneFunction=function(t){var n=function(){return t.apply(this,arguments)};n.prototype=t.prototype;for(var r in t)t.hasOwnProperty(r)&&(n[r]=e.copy(t[r]));return n};var t=e.copy=function(n,r,i){if(!n)return n;var s=null;if(!r&&typeof n._clone=="function")return n._clone();if(n.forEach){if(n._deep_shared_)return n;s=[];var o=n.length;for(var u=0;u<o;++u){var a=n[u];typeof a=="object"?s.push(t(a)):s.push(a)}}else if(typeof n=="object"){if(n._deep_shared_)return n;if(n instanceof RegExp)return n;if(n instanceof Date)return new Date(n.valueOf());s={};for(var f in n){if(f=="_backgrounds"||f=="_foregrounds"||f=="_transformations"){if(i)continue;s[f]=n[f].slice();continue}var l=n[f];typeof l=="object"?s[f]=t(l):s[f]=l}}else typeof n=="function"?n._deep_composer_?s=e.cloneFunction(n):s=n:s=n;return s};return e.shallowCopy=function(e){if(e&&e.forEach)return e.slice();if(e&&typeof e=="object"){if(e instanceof RegExp)return e;if(e instanceof Date)return new Date(e.valueOf());var t={};for(var n in e)t[n]=e[n];return t}return e},e}),define("deep-compiler/index",["require","deep-utils/index"],function(e,t){"use strict";function n(e){return e&&e.forEach?"array":typeof e}var r={};return r.Shared=function(e){return e._deep_shared_=!0,e},r.compile=function(){var e=t.copy(arguments[0]),n=arguments.length;for(var i=1;i<n;++i)r.aup(arguments[i],e);return e},r.decorateUpFrom=function(e,t,n){n.forEach(function(n){typeof e[n]!="undefined"&&(t[n]=r.aup(e[n],t[n]))})},r.decorateBottomFrom=function(e,t,n){n.forEach(function(n){typeof e[n]!="undefined"&&(t[n]=r.abottom(e[n],t[n]))})},r.upFromArgs=function(e,t,n){for(var i=t.length-1;i>-1;--i)e=r.aup(t[i],e,n);return e},r.bottomFromArgs=function(e,t,n){for(var i=t.length-1;i>-1;--i)e=r.abottom(t[i],e,n);return e},r.aup=function(e,i,s){if(typeof e=="undefined")return i;if(e===null)return null;s=s||{};if(typeof i=="undefined"||i===null)return t.copy(e,!1,s.excludeGrounds);if(i._deep_compiler_)return i=i._up(e),i;if(e._deep_compiler_)return e._clone&&(e=e._clone()),e._bottom(i);if(e._deep_shared_)return e._deep_shared_=!1,i=r.abottom(i,e),e._deep_shared_=!0,i;if(i._deep_shared_)return i._deep_shared_=!1,i=r.abottom(i,e),i._deep_shared_=!0,i;var o=n(e),u=n(i);if(o!==u)return i=t.copy(e,!1,s.excludeGrounds),i;switch(o){case"array":var a=r.upArray(e,i);return a;case"object":if(e instanceof RegExp)return e;if(e instanceof Date)return i=new Date(e.valueOf()),i;for(var f in e){if(f=="_backgrounds"||f=="_foregrounds"||f=="_transformations"){if(s.excludeGrounds)continue;i[f]=i[f]?i[f].concat(e[f]):e[f].slice();continue}if(typeof i[f]=="undefined"){i[f]=t.copy(e[f]);continue}if(e[f]===null){i[f]=null;continue}typeof e[f]=="object"||typeof e[f]=="function"?i[f]=r.aup(e[f],i[f]):i[f]=e[f],i[f]&&i[f]._deep_remover_&&delete i[f]}return i;default:return e}},r.abottom=function(e,i,s){s=s||{};if(e===null||typeof e=="undefined")return i;if(i===null)return i;if(typeof i=="undefined")return i=t.copy(e,!1,s.excludeGrounds),i;if(i._deep_compiler_)return i=i._bottom(e),i;if(e._deep_compiler_)return e._clone&&(e=e._clone()),e._up(i),e;if(e._deep_shared_)return e._deep_shared_=!1,e=r.aup(i,e),e._deep_shared_=!0,e;if(i._deep_shared_)return i._deep_shared_=!1,e=r.aup(i,e),i._deep_shared_=!0,e;var o=n(e),u=n(i);if(o!==u)return i;switch(o){case"array":var a=r.bottomArray(e,i);return a;case"object":for(var f in e){if(f=="_backgrounds"||f=="_foregrounds"||f=="_transformations"){if(s.excludeGrounds)continue;i[f]=i[f]?e[f].concat(i[f]):e[f].slice();continue}if(e[f]!==null){if(typeof i[f]=="undefined")i[f]=t.copy(e[f]);else if(typeof e[f]=="object"||typeof e[f]=="function")i[f]=r.abottom(e[f],i[f]);i[f]&&i[f]._deep_remover_&&delete i[f]}}var l=t.shallowCopy(i);for(f in i)delete i[f];for(f in e){if(!(f!="_backgrounds"&&f!="_foregrounds"&&f!="_transformations"||!s.excludeGrounds))continue;i[f]=l[f],delete l[f]}for(f in l)i[f]=l[f];return i;default:return i}},r.up=function(){var e=arguments[0];for(var t=1,n=arguments.length;t<n;t++)e=r.aup(arguments[t],e);return e},r.bottom=function(){var e=arguments[arguments.length-1],t=arguments[0];for(var n=arguments.length-2;n>0;n--)e=r.abottom(arguments[n],e);return r.abottom(t,e)},r.bottomArray=function(e,n,i,s){if(e.length===0)return n;var o={},u=e.length,a=null,f=0;for(;f<u;++f){var l=e[f];l&&i?a=t.fromPath(l,i):l&&l.id?a=l.id:a=String(l),o[a]={ref:l,index:f}}Array.prototype.unshift.apply(n,e);var c=n[f];while(f<n.length)c&&i?a=t.fromPath(c,i):c&&c.id?a=c.id:a=String(c),o[a]&&(n[o[a.index]]=r.aup(c,o[a].ref,{excludeGrounds:s}),n.splice(f,1)),c=n[++f];return n},r.upArray=function(e,n,i,s){if(e.length===0)return n;var o={},u=n.length,a=null,f=0;for(;f<u;++f){var l=n[f];l&&i?a=t.fromPath(l,i):l&&l.id?a=l.id:a=String(l),o[a]={ref:l,index:f}}f=0;var c=e[f],h=e.length;while(f<h)c&&i?a=t.fromPath(c,i):c&&c.id?a=c.id:a=String(c),o[a]?n[o[a.index]]=r.aup(c,o[a].ref,{excludeGrounds:s}):n.push(c),c=e[++f];return n},r}),define("deep-compiler/lib/classes",["require","../index","deep-utils/index"],function(e,t,n){"use strict";var r=function(){function t(){e.compiled||e.Constructor.compile();for(var t in this)this[t]&&typeof this[t]=="object"&&!this[t]._deep_shared_&&(this[t]=n.copy(this[t]));for(var r=0,i=e.constructors.length;r<i;++r)e.constructors[r].apply(this,arguments)}var e={constructors:null,compiled:!1,args:Array.prototype.slice.call(arguments)};return t.prototype={},t._deep_class_=!0,t._deep_compiler_=!0,t._link=function(t){e.links=e.links||[],e.links.push(t)},t._up=function(){return e.compiled=!1,e.args=e.args.concat(Array.prototype.slice.call(arguments)),e.links&&e.links.forEach(function(e){e.compiled=!1}),e.Constructor},t._bottom=function(){return e.compiled=!1,e.args=Array.prototype.slice.call(arguments).concat(e.args),e.links&&e.links.forEach(function(e){e.compiled=!1}),e.Constructor},t._clone=function(){return classes.Classes.apply(classes,e.args)},t.compile=function(t){if(!t&&e.compiled)return;e.constructors=[];var n=i(e);for(var r in n)if(typeof n[r]=="function"||typeof e.Constructor.prototype[r]=="undefined")e.Constructor.prototype[r]=n[r];e.compiled=!0},e.Constructor=t,t},i=function(e){var n={};for(var i=0,s=e.args.length;i<s;++i){var o=e.args[i];if(!o)throw new Error("You try to compose Classes with something wrong : "+String(o));if(o._deep_sheet_){if(!r.applySheet)throw new Error("You should install deep-sheets before applying sheets in deep.Classes constructors.");r.applySheet(n,o);continue}typeof o=="function"?(e.constructors.push(o),o.prototype&&(o._deep_class_&&(e.firstCompilation||(e.firstCompilation=!0,o._link(e)),o.compile()),n=t.aup(o.prototype,n))):n=t.aup(o,n)}return n};return r}),define("deep-utils/lib/array",["require","../index"],function(e,t){return t.sort=function(e,n){n||(n=["+"]),n.forEach||(n=[n]);var r=[];for(var i=0;i<n.length;i++){var s=n[i],o=s.charAt(0),u={attribute:s,ascending:!0};if(o=="-"||o=="+")o=="-"&&(u.ascending=!1),u.attribute=u.attribute.substring(1);e._deep_array_&&(u.attribute="value"+(u.attribute?"."+u.attribute:"")),r.push(u)}return e.sort(function(e,n){for(var i,s=0;i=r[s];s++){if(i.attribute===""){if(e!=n)return i.ascending==e>n?1:-1;return}e&&e._deep_query_node_&&(e=e.value),n&&n._deep_query_node_&&(n=n.value);var o=t.fromPath(e,i.attribute),u=t.fromPath(n,i.attribute);if(o!=u)return i.ascending==o>u?1:-1}return 0}),e},t.arrayUnique=function(n,r){if(!n.forEach)return n;var i={},s=0,o=[];return n.forEach(function(e){var n=null;r?n=t.fromPath(e,r):e.uri&&(n=e.uri);if(n===null||n===undefined)n=String(e);typeof i[n]=="undefined"&&(i[n]=!0,o.push(e))}),o},t.arrayFusion=function(n,r,i){var s={},o=0,u=[];return n&&n.length>0&&(u=u.concat(n)),u.forEach(function(e){var n=null;i?n=t.fromPath(e,i):e.uri&&(n=e.uri);if(n===null||n===undefined)n=String(e);s[n]=!0}),r.forEach(function(e){var n=null;i?n=t.fromPath(e,i):e.uri&&(n=e.uri);if(n===null||n===undefined)n=String(e);typeof s[n]=="undefined"&&u.push(e)}),u},t.inArray=function(t,n){if(!n||!n instanceof Array)return!1;var r={};n.forEach(function(e){r[e]=!0});if(t.forEach){var i=0;return t.forEach(function(e){r[e]&&i++}),i==t.length?!0:!1}return r[t]?!0:!1},t.argToArr=Array.prototype.slice,t.arrayInsert=function(e,t){return e.splice.apply(e,[t,0].concat(Array.prototype.slice.call(arguments,1))),e},t.removeInside=function(e,t){t.forEach||(t=[t]);var n={},r=null,i=null;for(var s=0,o=t.length;s<o;++s)r=t[s],typeof r=="object"?i=r.id:i=r,n[i]=r;if(e.forEach)for(var s=0,o=e.length;s<o;++s)r=e[s],typeof r=="object"?i=r.id:i=r,n[i]&&e.splice(s,1);else for(var s in e)r=e[s],typeof r=="object"?i=r.id:i=s,n[i]&&delete e[s];return e},t}),define("deep-compiler/lib/restrictions",["require","deep-utils/lib/array","../index"],function(e,t,n){"use strict";var r=function(e){return function(t,n){var r=new Error(e);return r.status=405,r}},i=function(){var e={};for(var t in arguments)e[arguments[t]]=r();return e},s=function(){return{inner:{},allowable:Array.prototype.slice.call(arguments),_deep_compiler_:!0,_deep_allow_only_:!0,_up:function(){var e=this.inner;for(var t=0,r=arguments.length;t<r;++t){var i=arguments[t];i._deep_allow_only_?(e=n.aup(i.inner,e),this.allowable=n.aup(i.allowable,this.allowable)):e=n.aup(i,e)}return this.inner=e,this},_bottom:function(){var e=this.inner,i=null;for(var s=arguments.length-1;s>=0;--s){var o=arguments[s];o._deep_allow_only_?(e=n.abottom(o.inner,e),this.allowable=n.aup(o.allowable,this.allowable)):e=n.abottom(o,e)}if(e._deep_restrictable_){var u=t.removeInside(e._deep_restrictable_.slice(),this.allowable);for(var a=0,f=u.length;a<f;++a)e[u[a]]=r()}else{if(!i){i={};for(var l=0,c=this.allowable.length;l<c;++l)i[this.allowable[l]]=!0}for(var h in e)typeof e[h]=="function"&&!i[h]&&(e[h]=r())}return e}}};return{Disallow:i,AllowOnly:s,forbidden:r}}),function(e){"use strict";e("deep-promise/index",[],function(){function t(e,t){typeof t!="undefined"&&(t instanceof Error?(e._state.success=null,e._state.error=t):(t&&t._deep_undefined_&&(t=undefined),e._state.success=t,e._state.error=null)),e._running=!1,e._executing||e._next()}function n(e,t){e._running=!1,e._state.success=null,e._state.error=t,e._executing||e._next()}function r(r){r._executing=!0;var i=function(e){return t(r,e)},s=function(e){return n(r,e)};while(!r._running){var o=r._state.queue.shift();if(r._state.error)while(o&&o.type=="done")o=r._state.queue.shift();else while(o&&o.type=="fail")o=r._state.queue.shift();if(!o)break;if(o.fn&&o.fn._deep_promise_){r._paused=!0,o.fn._context=r._context,o.fn.resolve();break}r._running=!0,r._state.oldQueue=r._state.queue,r._state.queue=[];var u=o.fn.call(r,r._state.success,r._state.error);if(u===r){r._state.oldQueue&&(r._state.queue.length?r._state.queue=r._state.queue.concat(r._state.oldQueue):r._state.queue=r._state.oldQueue,r._state.oldQueue=null),r._running=!1;continue}if(u&&typeof u.then=="function"){var a=u._deep_promise_||u._deep_chain_?u:e.when(u);a.done(i).fail(s)}else{r._running=!1;if(typeof u!="undefined"){var f;u!==null&&(u._deep_undefined_?(u=undefined,f=!1):f=u instanceof Error),r._state.success=f?null:u,r._state.error=f?u:null}}r._state.oldQueue&&(r._state.queue.length?r._state.queue=r._state.queue.concat(r._state.oldQueue):r._state.queue=r._state.oldQueue,r._state.oldQueue=null)}}function s(e){var t={};for(var n in e)t[n]=e[n];return t}var e={};e.Undefined={_deep_undefined_:!0},e.when=function(t){if(!t||!t.promise&&!t.then)return(new e.Promise).resolve(t);if(t._deep_deferred_)return t.promise();if(typeof t.then=="function"){var n=new e.Promise;return t.then(function(e){n.resolve(e)},function(e){n.reject(e)}),n}return typeof t.promise=="function"?t.promise():typeof t.promise=="object"?t.promise:(new e.Promise).resolve(t)},e.immediate=function(t){return(new e.Promise).resolve(t)},e.all=function(t){arguments.length>1&&(t=Array.prototype.slice.call(arguments));if(t.length===0)return e.immediate([]);var n=new e.Promise,r=t.length,i=0,s=-1,o=[];return t.every(function(e){if(n._rejected)return!1;var t=s+1;if(!e||!e.then){if(e instanceof Error)return n.ended()||n.reject(e),!1;o[t]=e,i++,i==r&&n.resolve(o)}else e.then(function(e){o[t]=e,i++,i==r&&n.resolve(o)},function(e){n.ended()||n.reject(e)});return s++,!0}),n},e.Deferred=function(){return this instanceof e.Deferred?(this._promises=[],this._deep_deferred_=!0,this):new e.Deferred},e.Deferred.prototype={_deep_deferred_:!0,_promises:null,rejected:!1,resolved:!1,canceled:!1,_success:null,_error:null,ended:function(){return this.rejected||this.resolved||this.canceled},resolve:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");if(e instanceof Error)return this.reject(e);this._success=e,this.resolved=!0;var t=this;this._promises.forEach(function(t){t.resolve(e)})},reject:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");this._error=e,this.rejected=!0;var t=this;this._promises.forEach(function(t){t.reject(e)})},promise:function(){var t=new e.Promise;return this.resolved?t.resolve(this._success):this.rejected?t.reject(this._error):(this._promises.push(t),t)}};var i=e.Promise=function(t,n){this._state=t=t||{},this._context=t.context||e.Promise.context,this._state.success=t.success||undefined,this._state.error=t.error||null,this._state.queue=t.queue||[],this._state.oldQueue=t.oldQueue||null,this._state.handlers=t.handlers||[],this._state.handlers.push(this),this._identity=e.Promise};return i.prototype={_locals:undefined,_deep_promise_:!0,_running:!1,_executing:!1,_initialised:!1,_resolved:!1,_rejected:!1,_enqueue:function(e,t){return this._state.queue.push({fn:e,type:t}),this._initialised&&!this._running&&!this._executing&&this._next(),this},_next:function(){if(!this._initialised||this._paused)return;var t=this,n;if(t._state.queue.length!==0){try{n=e.Promise.context,n!==t._context&&(n&&n.suspend&&n.suspend(),e.Promise.context=t._context,t._context&&t._context.resume&&t._context.resume()),r(t)}catch(i){t._context.debug&&(e.Promise.dumpError?e.Promise.dumpError(i):console.error(i)),t._state.success=null,t._state.error=i,t._running=!1;if(t._context.rethrow)throw i}finally{n!==t._context&&(t._context&&t._context.suspend&&t._context.suspend(),n&&n.resume&&n.resume(),e.Promise.context=n)}t._executing=!1}},ended:function(){return this._resolved||this._rejected},resolve:function(e){if(this.ended())throw new Error("promise already resolved or rejected");this._resolved=!0,this._paused=!1,this._initialised=!0,typeof e!="undefined"&&(this._state.success=e);var t=this._state.success instanceof Error;return this._state.error=t?this._state.success:this._state.error,this._state.success=t?null:this._state.success,this._next(),this},reject:function(e){if(this.ended())throw new Error("promise already resolved or rejected");return this._rejected=!0,this._paused=!1,this._initialised=!0,this._state.error=e,this._next(),this},close:function(){var e=this;return this._state.handlers.length==1?this:(this._state.handlers.pop(),this._state.handlers[this._state.handlers.length-1])},clone:function(){return new this._identity({handlers:this._state.handlers.slice(),queue:this._state.queue?this._state.queue.slice():[],oldQueue:this._state.oldQueue?this._state.oldQueue.slice():null,success:this._state.success,error:this._state.error})},catchError:function(e){var t=this;return this.always(function(){t.toContext("rethrow",e?!0:!1)})},pushTo:function(e){var t=this;return t._initialised?this.always(function(){e.push(t)}):(e.push(t),this)},done:function(e){var t=this,n=function(n){if(!e)return n;var r=e.call(t,n);if(r===t)return;return r};return t._enqueue(n,"done")},spread:function(e){var t=this,n=function(e){if(!callBack)return e;var n=callBack.apply(t,e&&e.forEach?e:[e]);if(n===t)return;return n};return t._enqueue(n,"done")},fail:function(e){var t=this,n=function(n,r){if(!e)return r;var i=e.call(t,r);if(i===t)return;return i};return t._enqueue(n,"fail")},always:function(e){var t=this,n=function(n,r){if(!e)return r||n;var i=e.call(t,n,r);if(i===t)return;return i};return t._enqueue(n,"always")},then:function(e,t){var n=this,r=null;return e&&this.done(function(t){var r=e.call(n,t);if(r===n)return;return r}),t&&this.fail(function(e){var r=t.call(n,e);if(r===n)return;return r}),this},delay:function(t){return this.always(function(){var n,r=new e.Promise;return setTimeout(function(){r.resolve(undefined)},t),r})},toState:function(e,t){var n=this;return this.done(function(r){return e?(t=typeof t=="undefined"?r:t,n._state[e]=t,t):new Error(".toState need key/val couple.")})},fromState:function(e){var t=this;return this.done(function(n){if(!e)return t._state;var r=t._state[e];return typeof r=="undefined"?deep.Undefined:r})},when:function(e){return this.done(function(){return e})}},e.promisify=function(e,t){return function(){var n=Array.prototype.slice.call(arguments),r=new r.Promise;return n.push(function(){var e=Array.prototype.slice.call(arguments),t=e.shift();t?r.reject(t):r.resolve(e.length<=1?e[1]:e)}),e.apply(t||{},n),r}},e.async=function(e,t,n){var r=new r.Promise,i=function(){var e=Array.prototype.slice.apply(arguments),t=e.shift();t?r.reject(t):e.length?e.length==1?r.resolve(e[0]):r.resolve(e):r.resolve(!0)};return n.push(i),e?typeof t=="string"?e[t].apply(e,n):t.apply(e,n):t.apply({},n),r},e.loop=function(e,t,n,r){var i=0,s=!1,o=function(r){if(s)return r;if(n){i++;if(n<i)return r}return this.done(e).delay(t).done(o),r},u=(new prom.Promise).resolve(r).done(o);return u.finish=function(){s=!0},u},i.getLogger=function(){return e.Promise.context&&e.Promise.context.logger||e.Promise.logger||console},i.prototype.log=function(){var e=Array.prototype.slice.call(arguments);return this.elog.apply(this,e).slog.apply(this,e)},i.prototype.elog=function(){var t=Array.prototype.slice.call(arguments);return this.fail(function(n){var r=e.Promise.getLogger();t.push(n),r.error.apply(r,t)})},i.prototype.slog=function(){var t=Array.prototype.slice.call(arguments);return this.done(function(n){var r=e.Promise.getLogger();t.push(n),r.log.apply(r,t)})},i.context={rethrow:!1,debug:!0},e.contextualisePromise=function(t){return t._context=e.Promise.context=e.Promise.context?s(e.Promise.context):{},t._contextualised=!0,e.Promise.context},i.prototype.toContext=function(e,t){var n=this;return this.done(function(r){if(!e)return new Error(".toContext need key/val couple or an object as first argument.");if(typeof e=="object"){for(var i in e)n._context[i]=e[i];return r}return t=typeof t=="undefined"?r:t,n._context[e]=t,r})},i.prototype.contextualise=function(t){var n=this;return this.done(function(r){n._context=e.contextualisePromise(n),n._contextualised=!0;if(t)for(var i in t)n._context[i]=t[i];return r})},i.prototype.fromContext=function(t){var n=this;return this.done(function(){if(!t)return n._context;var r=n._context[t];return typeof r=="undefined"?e.Undefined:r})},i.prototype.clog=function(t){var n=this;return this.always(function(){t?e.Promise.getLogger().log("promise.context."+t+" : ",n._context[t]):e.Promise.getLogger().log("promise.context : ",n._context)})},i.prototype.debug=function(){var t=Array.prototype.slice.call(arguments);return this.always(function(n,r){if(!e.Promise.context.debug)return;var i=e.Promise.getLogger();t.push(r||n),i.debug?i.debug.apply(i,t):i.log.apply(i,t)})},e})}(typeof define!="undefined"?define:function(e,t){typeof module!="undefined"?module.exports=t():promise=t()}),define("deep-utils/lib/catch-parenthesis",[],function(){return function(e){if(e[0]!="(")return null;var t=1,n=1,r="";while((e[t]!=")"||n>1)&&t<e.length)e[t]=="("&&n++,e[t]==")"&&n--,e[t]==")"?n>1&&(r+=e[t++]):r+=e[t++];return t++,{value:r,rest:e.substring(t)}}}),define("deep-protocols/index",["require","deep-promise/index","deep-utils/lib/catch-parenthesis"],function(e,t,n){typeof requirejs!="undefined"&&(requirejs.onError=function(e){console.error("requirejs error : ",e.requireType,e),e.requireType==="timeout"&&console.error("modules: ",e.requireModules)});var r={};r.protocol=function(e,n){if(n)return r.protocols[e]=n,n;var i;typeof e=="object"||e._deep_ocm_?i=e:(!i&&t.Promise.context.protocols&&(i=t.Promise.context.protocols[e]),i||(i=r.protocols[e]));var s=new t.Promise;return i?i._deep_ocm_?i.flatten().done(function(t){return t=t(),t&&t.init?(this.when(t),t.init()):t||new Error("ProtocolError : no provider found with : "+e)}):i.init?t.when(i.init()).when(i):s.resolve(i):s.reject(new Error("ProtocolError : no provider found with : "+e))};var i=function(e,t){t=t||{};var r=e.indexOf("(");if(r>-1){var i=n(e.substring(r));e=e.substring(0,r),i&&(t.args=i.value.split(","))}var s=e.split(".");return t.method="get",s.length==2&&(e=s[0],t.method=s[1]),t.protocol=e,t};return r.parseRequest=function(e){if(!e||e[0]=="<")return e;var t=e.substring(0,50).indexOf("::"),n=null,s=e;if(t>-1){n=e.substring(0,t),s=e.substring(t+2),n=="this"&&(n="dq");var o={_deep_request_:!0,request:e,uri:s,execute:function(e){var t=this;return r.protocol(this.protocol).done(function(n){if(!n[t.method])return new Error("ProtocolError : no associate method found in provider "+t.name+" with : "+t.method);if(t.args){var r=t.args.slice();return r.push(t.uri,e),n[t.method].apply(n,r)}return n[t.method](t.uri,e)})}};return i(n,o),o}return e},r.getAll=function(e,n){var i=[];return e.forEach||(e=[e]),e.forEach(function(e){i.push(r.get(e,n))}),t.all(i)},r.get=function(e,n){var i=typeof e;return!e||i!=="string"&&!e._deep_request_?t.when(e):(n=n||{},i==="string"&&(e=r.parseRequest(e)),e._deep_request_?t.when(e.execute(n)).done(function(e){return n.wrap?(n.wrap.result?typeof n.wrap.result.push=="function"?n.wrap.result.push(e):n.wrap.result=[].concat(n.wrap.result):n.wrap.result=e,n.wrap):e}):t.when(e))},r.protocols={js:{get:function(n,r){typeof n=="object"&&(n=n.uri);var i=new t.Promise;try{e([n],function(e){i.resolve(e)},function(e){i.reject(e)})}catch(s){i.ended()||i.reject(s)}return i}},instance:{get:function(e,t){return r.protocols.js.get(e,t).done(function(e){return typeof e=="function"?new e:utils.copy(e)})}},dummy:{get:function(e,t){return{dummy:e}}}},r}),define("deepjs/lib/cache",[],function(){var e={};return{clear:function(t){t?delete e[t]:e={}},remove:function(t,n){e[t]&&delete e[t][n]},add:function(t,n,r,i){var s=e[n]=e[n]||{};return s[r]={response:t,stamp:i?Date.now().valueOf()+i:null},t},get:function(t,n){var r=e[t];if(!r)return;var i=r[n];if(!i)return i;if(i.stamp&&Date.now().valueOf()>i.stamp){delete r[n];return}return i.response}}}),define("deepjs/lib/promise",["require","deep-promise/index","deep-compiler/lib/classes"],function(e,t,n){var r=n(t.Promise);for(var i in t.Promise)r[i]=t.Promise[i];return t.Promise=r,t}),define("deep-modes/index",["require","deep-promise/index","deep-utils/index","deep-utils/lib/array"],function(e,t,n){var r={},i={};return r.setModesIn=function(e,t,n){if(typeof t=="string")e[t]=n;else for(var r in t)e[r]=t[r]},r.Modes=function(e,t){if(!e)return i;if(!t&&typeof e=="string")return i[e];r.setModesIn(i,e,t)},r.currentModes=function(e){var r=t.Promise.context||{};if(arguments.length>0&&(typeof e=="string"||e&&e.forEach)){var s=[],o=arguments;e.forEach&&(o=e);for(var u=0,a=o.length;u<a;++u){var f=o[u];r.modes&&r.modes[f]?s=s.concat(r.modes[f]):i[f]&&(s=s.concat(i[f]))}return s}var l=n.copy(i);if(r.modes)for(var u in r.modes)l[u]=r.modes[u];if(!e)return l;for(var u in e)l[u]=e[u];return l},r.matchModes=function(e,t){return n.inArray(e,r.currentModes(t))},r}),function(e){"use strict";e("decompose/index",[],function(){function r(e,t,n,r){var i=null;try{i=e.apply(t,n)}catch(s){i=s}finally{if(!i)return i;if(typeof i.then=="function")return i.then(function(e){return e},function(e){var n=r.call(t,e);return typeof n=="undefined"?e:n});if(i instanceof Error){var o=r.call(t,i);return typeof o=="undefined"?i:o}return i}}var e=function(t,n){var r={queue:[],compiled:!1};t&&(t.__composition__?r.queue=t._queue().slice():t.forEach?r.queue=t.slice():r.queue=[{fn:t,type:n||"fn"}]);var s=function(){return r.compiled||(r.compiled=i(r)),r.compiled.apply(this,arguments)};return s._deep_compiler_=!0,s.__composition__=!0,s._clone=function(){return e(r.queue)},s._compile=function(){return r.compiled?r.compiled:i(r)},s._queue=function(e,t){return e?(r.compiled=null,r.queue.push({fn:e,type:t||"after"}),this):r.queue},s._up=function(e){return e?(r.compiled=null,e.__composition__?(r.queue=r.queue.concat(e._queue()),this):(r.queue=[{fn:e,type:"fn"}],this)):e===null?null:this},s._bottom=function(e){return r.queue[0].type=="fn"?this:e?(r.compiled=null,e.__composition__?r.queue=e._queue().concat(r.queue):typeof e=="function"&&r.queue.unshift({fn:e,type:"fn"}),this):this},s.after=function(e){return this._queue(e,"after")},s.before=function(e){return this._queue(e,"before")},s.around=function(e){return this._queue(e,"around")},s.fail=function(e){return this._queue(e,"fail")},s.done=function(e){return this._queue(e,"after")},s.always=function(e){return this.after(e).fail(e)},s};e.Arguments=function(e){return e.forEach||(e=[e]),e._compo_arguments_=!0,e},e.Composer=function(t){var n=function(r,i){var s=e(r,i);for(var o in t)s[o]=t[o];return s._clone=function(){return n(this._queue())},s};return n.add=function(e,n){return t[e]=n,this},n};var t=function(e,t,n,r){t._deep_ocm_&&(t=t());if(!t)return e;typeof e!="undefined"&&(r=e&&e._compo_arguments_?e:[e]);var i=t.apply(n,r);return i&&typeof i.then=="function"?i.then(function(t){return typeof t=="undefined"?e:t}):typeof i=="undefined"?e:i},n=function(e,n){return function(){var r=this,i,s=e,o=n,u=arguments;return s._deep_ocm_&&(s=s()),s&&(i=s.apply(this,u)),i instanceof Error?i:i&&typeof i.then=="function"?i.then(function(e){return t(e,o,r,u)}):t(i,o,r,u)}},i=function(e){var t=e.queue;if(!t.length)return function(){};if(t[0].type==="around")throw new Error("composition starting with 'around' : could not be compiled. aborting.");var i=null,s=t.length;return t.forEach(function(t){var s=null;switch(t.type){case"fn":i=t.fn;break;case"after":i?i=n(i,t.fn,e):i=t.fn;break;case"before":i?i=n(t.fn,i,e):i=t.fn;break;case"around":s=i,i=function(){var e=t.fn(s);if(!e)throw new Error(".around() composition is used without returning a function. aborting.");return e.apply(this,arguments)};break;case"fail":s=i,i=function(){if(!s)return;return r(s,this,arguments,t.fn)};break;default:throw new Error("composition unrecognised : "+t.type)}}),e.compiled=i,i};return e.up=function(){var e=Array.prototype.slice.call(arguments),t=e[e.length-1];if(!t.__composition__)return t;var n=e.shift();while(!n)n=e.shift();if(n.__composition__){for(var r=0,i=e.length;r<i;++r)n._up(e[r]);return n}var s=e.pop()._clone();for(var i=e.length-1;i>=0;--i)s._bottom(e[i]);return s._bottom(n),s},e.bottom=function(){var e=Array.prototype.slice.call(arguments),t=e.pop();if(t.__composition__)for(var n=e.length-1;n>=0;--n)t._bottom(e[n]);return t},e.compile=function(){var e=Array.prototype.slice.call(arguments),t=e.pop();if(t.__composition__){t=t._clone();for(var n=e.length-1;n>=0;--n)t._bottom(e[n])}return t},e})}(typeof define!="undefined"?define:function(e,t){typeof module!="undefined"?module.exports=t():decompose=t()}),define("deep-utils/lib/schema",["require"],function(e){var t={},n=/^[0-9]*$/;return t.retrieveFullSchemaByPath=function(e,t,r){t+="";if(t=="/")return e;if(t[0]=="/"||t.substring(0,1)=="./")r="/";var i=t.split(r||".");r=="/"&&(i[0]===""||i[0]==".")&&i.shift();if(i.length==0)return e;var s=e;while(i.length>1&&s){var o=i.shift();if(o.match(n)&&s.type=="array"){s=s.items||null;continue}if(!s.properties||!s.properties[o])return null;s=s.properties[o]}if(!s)return null;var u=i.shift(),a=[];if(u.match(/^[0-9]*$/))s.type=="array"&&(s=s.items||{},a.push(s));else{s.properties&&s.properties[u]&&a.push(s.properties[u]);if(a.length===0)return s.additionalProperties===undefined||s.additionalProperties===!1?null:s.additionalProperties}var f={};return a.length!=1?null:(f=a[0],f)},t.schemaByValuePath=function(e,t,n){if(t[0]=="/"||t.substring(0,1)=="./")n="/";var r=t.split(n||".");n=="/"&&(r[0]===""||r[0]==".")&&r.shift();var i=e;while(r.length>1){var s=r.shift();if(!i.properties||!i.properties[s])return undefined;i=i.properties[s]}return i&&i.properties?i.properties[r.shift()]:undefined},t.getValuesQueryBySchemaPath=function(e,t,n){if(path[0]=="/"||path.substring(0,1)=="./")n="/";return n=="/"?(t=t.replace(/\/properties/,""),t=t.replace(/\/items/,"[]")):(t=t.replace(/\./,"/"),t=t.replace(/\/properties/,""),t=t.replace(/\/items/,"[]"),schemapPath="/"+t),t},t}),define("deep-utils/lib/string",["require","./catch-parenthesis"],function(e,t){function r(e,t,n){return expString=e.split(/\s+/,t),expString.length==1?(n=n||10,expString[0].length>n?e.substring(0,n):expString[0]):(theNewString=expString.join(" "),theNewString.length<e.length&&theNewString[theNewString.length-1]!="."&&(theNewString+="..."),theNewString)}var n={};n.catchParenthesis=t,n.Hash=function(e){var t=0;if(e.length==0)return t;for(i=0;i<e.length;i++)char=e.charCodeAt(i),t=(t<<5)-t+char,t&=t;return t},n.guid=function(){function e(e){var t=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+t.substr(0,4)+"-"+t.substr(4,4):t}return e()+e(!0)+e(!0)+e()},n.stripFirstSlash=function(e){return e.substring(0,1)=="/"?e.substring(1):e},n.trimWords=function(e,t,n){return r(e.replace(/<[^>]*>/gi,""),t,n)};var s=/\s(.)/g,o=/([^\s])([^\s]*)/g;n.camelCase=function(e){return e.toLowerCase().replace(s,function(e,t){return t.toUpperCase()})},n.titleCase=function(e){return e.toLowerCase().replace(o,function(e,t,n){return t.toUpperCase()+n})};var u=function(e,t){return t&&t._deep_query_node_?nodes.print(t):typeof t=="function"?"Function":t instanceof Date?t.toString():t instanceof RegExp?t.toString():typeof jQuery!="undefined"&&t instanceof jQuery?"jquery:"+t.selector:t};return n.stringify=function(e,t){return JSON.stringify(e,u,t?null:" ")},n}),define("deep-nodes/index",["require","deep-utils/index","deep-utils/lib/schema","deep-utils/lib/string"],function(e,t,n){var r={};return r.Node=function(e,t){var r=null,i=null;t&&(r=t.path,t.key?r+="/"+e:r+=e,t.schema&&(i=n.retrieveFullSchemaByPath(t.schema,e,"/")),this.value=t.value[e],this.paths=t.paths.concat(e),this.depth=t.depth+1,this.root=t.root||t),this._deep_query_node_=!0,this.path=r,this.key=e,this.ancestor=t,this.schema=i},r.Node.prototype={toString:function(e){var n="[QueryNode : "+this.path+" : value : "+t.stringify(this.value);return e&&(this.schema&&(n+=" - schema : "+t.stringify(this.schema)),n+=" - depth : "+this.depth),n+="]",n},set:function(e){return this.value=e,this.ancestor&&(this.ancestor.value[this.key]=e),e},clone:function(){return this.ancestor?new r.Node(this.key,this.ancestor):r.root(this.value,this.schema)}},r.val=function(e){return e._deep_array_?e.map(function(e){return e.value}):e._deep_query_node_?e.value:e},r.paths=function(e){return node._deep_query_node_?[node.path]:node.map(function(e){return e._deep_query_node_?e.schema:null})},r.schemas=function(e){return e._deep_query_node_?[e.schema]:e.map(function(e){return e._deep_query_node_?e.schema:null})},r.each=function(e,t){return e.forEach?e.forEach(t):t(e),e},r.map=function(e,t){return e.forEach?e.map(t):e._deep_query_node_?t(e):t(e)},r.clone=function(e){return e.forEach?e.slice():e._deep_query_node_?e.clone():t.copy(e)},r.root=function(e,t){e&&e._deep_undefined_&&(e=undefined);var n=new r.Node;return n.value=e,n.path="/",n.paths=[],n.key=null,n.ancestor=null,n.schema=t,n.depth=0,n.root=null,n},r.create=function(e,t){return new r.Node(e,t)},r}),define("deep-utils/lib/interpret",["require","../index"],function(e,t){return t.interpret=function(e,n){var r=e.indexOf("{");if(r==-1)return e;var i=e.substring(0,r);r++;var s=e.length;while(r<s){var o=[],u=e[r],a="";while(r<s&&u!="}"&&u!="|"){if(u=="+")o.push(a),a="";else if(u=="'"){var f=e.indexOf("'",r+1);a=e.substring(r,f),r=f}else u!=" "&&(a+=u);u=e[++r]}o.push(a);var l=e[r]=="|";if(e[r]=="}"||l){var c=null;for(var h=0;h<o.length;++h){a=o[h],a[0]=="'"?h===0?c=a.substring(1):c+=a.substring(1):(h===0?c=t.fromPath(n,a,"."):c+=t.fromPath(n,a,"."),c&&c.forEach&&(c=c.join(",")));if(!c)break}c&&(i+=c,l&&(r=e.indexOf("}",r))),r++;if(!c&&l)continue}while(r<s&&e[r]!="{")i+=e[r++];e[r]=="{"&&r++}return i},t}),define("rql/parser",["exports"],function(e){function n(n,i){function f(t){s.args.push(t),s=t,e.lastSeen.indexOf(s.name)>=0&&(o.cache[s.name]=s.args)}function l(e){if(!s.name)s.name=e;else if(s.name!==e)throw new Error("Can not mix conjunctions within a group, use paranthesis around each set of same conjuctions (& and |)")}function c(e){return e&&e.args&&(delete e.parent,e.args.forEach(c)),e}if(typeof n=="undefined"||n===null)n="";var s=new e.Query,o=s;o.cache={};if(typeof n=="object"){if(n instanceof e.Query)return n;for(var u in n){var s=new e.Query;o.args.push(s),s.name="eq",s.args=[u,n[u]]}return o}if(n.charAt(0)=="?")throw new URIError("Query must not start with ?");e.jsonQueryCompatible&&(n=n.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),n.indexOf("/")>-1&&(n=n.replace(/[\+\*\$\-:\w%\._]*\/[\+\*\$\-:\w%\._\/]*/g,function(e){return"("+e.replace(/\//g,",")+")"})),n=n.replace(/(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)([<>!]?=(?:[\w]*=)?|>|<)(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)/g,function(e,n,r,i){if(r.length<3){if(!t[r])throw new URIError("Illegal operator "+r);r=t[r]}else r=r.substring(1,r.length-1);return r+"("+n+","+i+")"}),n.charAt(0)=="?"&&(n=n.substring(1));var a=n.replace(/(\))|([&\|,])?([\+\*\$\-:\w%\._]*)(\(?)/g,function(t,n,u,a,c){u&&(u==="&"&&l("and"),u==="|"&&l("or"));if(c){var h=new e.Query;h.name=a,h.parent=s,f(h)}else if(n){var p=!s.name;s=s.parent;if(!s)throw new URIError("Closing paranthesis without an opening paranthesis");p&&s.args.push(s.args.pop().args)}else if(a||u===","){s.args.push(r(a,i)),e.lastSeen.indexOf(s.name)>=0&&(o.cache[s.name]=s.args);if(s.name==="eq"&&s.args[0]===e.primaryKeyName){var d=s.args[1];d&&!(d instanceof RegExp)&&(d=d.toString()),o.cache[e.primaryKeyName]=d}}return""});if(s.parent)throw new URIError("Opening paranthesis without a closing paranthesis");if(a)throw new URIError("Illegal character in query string encountered "+a);return c(o),o}function r(t,n){var r=e.converters["default"];if(t.charAt(0)==="$"){var i=parseInt(t.substring(1))-1;return i>=0&&n?n[i]:undefined}if(t.indexOf(":")>-1){var s=t.split(":",2);r=e.converters[s[0]];if(!r)throw new URIError("Unknown converter "+s[0]);t=s[1]}return r(t)}var t={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};e.primaryKeyName="id",e.lastSeen=["sort","select","values","limit"],e.jsonQueryCompatible=!0,e.parse=e.parseQuery=n,e.parseGently=function(){var t;try{t=n.apply(this,arguments)}catch(r){t=new e.Query,t.error=r.message}return t},e.commonOperatorMap={and:"&",or:"|",eq:"=",ne:"!=",le:"<=",ge:">=",lt:"<",gt:">"};var i=e.autoConverted={"true":!0,"false":!1,"null":null,"undefined":undefined,Infinity:Infinity,"-Infinity":-Infinity};return e.converters={auto:function(t){if(i.hasOwnProperty(t))return i[t];var n=+t;if(isNaN(n)||n.toString()!==t)return t=decodeURIComponent(t),e.jsonQueryCompatible&&t.charAt(0)=="'"&&t.charAt(t.length-1)=="'"?JSON.parse('"'+t.substring(1,t.length-1)+'"'):t;return n},number:function(e){var t=+e;if(isNaN(t))throw new URIError("Invalid number "+t);return t},epoch:function(e){var t=new Date(+e);if(isNaN(t.getTime()))throw new URIError("Invalid date "+e);return t},isodate:function(t){var n="0000".substr(0,4-t.length)+t;return n+="0000-01-01T00:00:00Z".substring(n.length),e.converters.date(n)},date:function(e){var t=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(e);t?date=new Date(Date.UTC(+t[1],+t[2]-1,+t[3],+t[4],+t[5],+t[6])):date=new Date(e);if(isNaN(date.getTime()))throw new URIError("Invalid date "+e);return date},"boolean":function(e){return e==="true"},string:function(e){return decodeURIComponent(e)},re:function(e){return new RegExp(decodeURIComponent(e),"i")},RE:function(e){return new RegExp(decodeURIComponent(e))},glob:function(e){var t=decodeURIComponent(e).replace(/([\\|\||\(|\)|\[|\{|\^|\$|\*|\+|\?|\.|\<|\>])/g,function(e){return"\\"+e}).replace(/\\\*/g,".*").replace(/\\\?/g,".?");return t.substring(0,2)!==".*"?t="^"+t:t=t.substring(2),t.substring(t.length-2)!==".*"?t+="$":t=t.substring(0,t.length-2),new RegExp(t,"i")}},e.converters["default"]=e.converters.auto,e.Query=function(){this.name="and",this.args=[]},e}),define("deep-nodes/lib/rql",["require","deep-utils/lib/array","rql/parser"],function(e,t,n){"use strict";function r(e){return e&&e.forEach?"array":typeof e}function u(e){if(typeof e=="object"){var t=e.name,n=e.args;if(e.forEach)return e.map(u);var r=n[0],i=null;n.length==2&&(i=r,r=n[1]);var s=null,f=!1;switch(t){case"eq":f=!0,s=function(t){return(a(t,i)||undefined)===r};break;case"ne":f=!0,s=function(t){return(a(t,i)||undefined)!==r};break;case"le":f=!0,s=function(t){return(a(t,i)||undefined)<=r};break;case"ge":f=!0,s=function(t){return(a(t,i)||undefined)>=r};break;case"lt":f=!0,s=function(t){return(a(t,i)||undefined)<r};break;case"gt":f=!0,s=function(t){return(a(t,i)||undefined)>r};break;default:var l=o.ops[t];if(!l)throw new Error("RQLError : no operator found in rql with : "+t);n&&n.length>0?(n=n.map(u),s=function(){return l.apply(this,n)}):s=function(){return l.call(this)}}return f?function(){var e=this.filter(s);return e}:s}return e}function a(e,t){if(!t)return e._deep_query_node_?e.value:e;var n=t.split("."),i=e;switch(n[0]){case"_schema":if(!e._deep_query_node_)return undefined;n.shift(),i=e.schema;break;case"_depth":if(e._deep_query_node_)return e.depth;return undefined;case"_type":if(e._deep_query_node_)return r(e.value);return r(e);default:e._deep_query_node_&&(i=i.value)}if(!i)return i;var s=n.length,o=!1;n[s-1]=="_type"&&(s--,o=!0,n.pop());if(s<5){var u;switch(s){case 1:u=i[n[0]];break;case 2:u=i[n[0]]&&i[n[0]][n[1]];break;case 3:u=i[n[0]]&&i[n[0]][n[1]]&&i[n[0]][n[1]][n[2]];break;case 4:u=i[n[0]]&&i[n[0]][n[1]]&&i[n[0]][n[1]][n[2]]&&i[n[0]][n[1]][n[2]][n[3]]}return typeof u!="undefined"&&o?r(u):u}i=i[n[0]]&&i[n[0]][n[1]]&&i[n[0]][n[1]][n[2]]&&i[n[0]][n[1]][n[2]][n[3]];if(typeof i=="undefined")return undefined;var a=4,f=n[a];while(f&&i[f])i=i[f],f=n[++a];return a===s?o?r(i):i:undefined}function f(e,t){var n=function(n,r){typeof r=="undefined"&&(r=n,n=undefined);var i=arguments,s=[];for(var o=0,u=this.length;o<u;o++){var a=this[o];e(c(a,n),r)&&s.push(a)}return s};return n.condition=e,n}function l(e){return function(t){return t?this.map(function(e){return a(e,t)}).reduce(e):this.reduce(e)}}function c(e,t){return t&&t.forEach?a(e,decodeURIComponent(t)):typeof t=="undefined"?a(e):a(e,decodeURIComponent(t))}var i=n.parseQuery,s={},o=function(e,t){return t[0]=="?"&&(t=t.substring(1)),s[t]?s[t].call(e):o.compile(t).call(e)};return o.parse=function(e){try{var t=i(e);return t.toString=function(){return e},t}catch(n){return null}},o.compile=function(e){var t=o.parse(e),n=u(t);return s[e]=n,n},o.ops={isPresent:function(e,t){var n=[],r=t.length;for(var i=0;i<r;++i)a(t[i],e)&&n.push(t[i]);return n},sort:function(){var e=[];for(var t=0;t<arguments.length;t++){var n=arguments[t],r=n.charAt(0),i={attribute:n,ascending:!0};if(r=="-"||r=="+")r=="-"&&(i.ascending=!1),i.attribute=i.attribute.substring(1);e.push(i)}return this.sort(function(t,n){for(var r,i=0;r=e[i];i++){var s=a(t,r.attribute),o=a(n,r.attribute);if(s!=o)return r.ascending==s>o?1:-1}return 0}),this},match:f(function(e,t){return(new RegExp(t)).test(e)}),"in":f(function(e,t){var n=!1,r=0;while(!n&&r<t.length)t[r++]==e&&(n=!0);return n}),out:f(function(e,t){var n=!0,r=0;while(n&&r<t.length)t[r++]==e&&(n=!1);return n}),contains:f(function(e,n){return t.inArray(n,e)}),excludes:f(function(e,n){return!t.inArray(n,e)}),or:function(){var e=[];for(var t=0;t<arguments.length;++t){var n=arguments[t];typeof n=="function"?e=e.concat(n.call(this)):e=e.concat(o.ops.isPresent(n,e))}return e},and:function(){var e=this;for(var t=0;t<arguments.length;++t){var n=arguments[t];typeof n=="function"?e=n.call(e):e=o.ops.isPresent(n,e)}return e},select:function(){var e=arguments,t=arguments.length,n=this.map(function(n){var r={};for(var i=0;i<t;i++){var s=e[i],o=c(n,s);typeof o!="undefined"&&(r[s]=o)}return r});return n},unselect:function(){var e=arguments,t=arguments.length;return this.map(function(n){var r={};for(var i in n)n.hasOwnProperty(i)&&(r[i]=n[i]);for(var i=0;i<t;i++)delete r[e[i]];return r})},values:function(e){if(arguments.length==1)return this.map(function(t){return a(t,e)});var t=arguments,n=arguments.length;return this.map(function(e){var r=a(e),i=[];if(n===0)for(var s in r)r.hasOwnProperty(s)&&i.push(r[s]);else for(var s=0;s<n;s++){var o=t[s];i.push(r[o])}return i})},limit:function(e,t,n){var r=this.length;t=t||0;var i=this.slice(t,t+e);return n&&(i.start=t,i.end=t+i.length-1,i.totalCount=Math.min(r,typeof n=="number"?n:Infinity)),i},distinct:function(){var e={},t=[],n=this.filter(function(n){return n=a(n),n&&typeof n=="object"?n.__found__?!1:(n.__found__=function(){},t.push(n),!0):e[n]?!1:(e[n]=!0,!0)});return t.forEach(function(e){delete e.__found__}),n},recurse:function(e){function n(r){if(r.forEach)r.forEach(n);else{t.push(r);if(e)r=r[e],r&&typeof r=="object"&&n(r);else for(var i in r)r[i]&&typeof r[i]=="object"&&n(r[i])}}var t=[];return n(a(this)),t},aggregate:function(){var e=[],t=[];for(var n=0;n<arguments.length;n++){var r=arguments[n];typeof r=="function"?t.push(r):e.push(r)}var i={},s=e.length;this.forEach(function(t){t=a(t);var n="";for(var r=0;r<s;r++)n+="/"+t[e[r]];var o=i[n];o||(o=i[n]=[]),o.push(t)});var o=t.length,u=[];for(var f in i){var l=i[f],c={};for(var n=0;n<s;n++){var h=e[n];c[h]=l[0][h]}for(var n=0;n<o;n++){var p=t[n];c[n]=p.call(l)}u.push(c)}return u},between:f(function(e,t){return e=a(e),e>=t[0]&&e<t[1]}),sum:l(function(e,t){return e=a(e),t=a(t),e+t}),mean:function(e){return o.ops.sum.call(this,e)/this.length},max:l(function(e,t){return e=a(e),t=a(t),Math.max(e,t)}),min:l(function(e,t){return e=a(e),t=a(t),Math.min(e,t)}),count:function(){return this.length},first:function(){return this[0]},last:function(){return this[this.length-1]},random:function(){return this[Math.round(Math.random()*(this.length-1))]},one:function(){if(this.length>1)throw new Error("RQLError : More than one object found");return this[0]}},o}),define("deep-nodes/lib/query",["require","../index","./rql","deep-utils/lib/array","deep-utils/lib/catch-parenthesis"],function(e,t,n,r,i){"use strict";var s={},o=function(){};o.prototype.analyseEreg=function(t,n){var r=i(t),s=r.value,o="",u=r.rest,a=this;if(u[0]=="g"||u[0]=="i"){o=u[0];if(u[1]=="g"||u[1]=="i")o+=u[1]}return u=u.substring(o.length),n.push({type:"selector",value:s,options:o,handler:function(e){var t=[];for(var n in e.value)if((new RegExp(this.value,this.options)).test(n)){var r=a.returnProperty(e,n);typeof r!="undefined"&&r!==null&&t.push(r)}return t}}),u},o.prototype.analyse=function(t){var n=[],r=t;this.asked=t;while(r.length>0){r=this.analyseMoves(r,n);if(n.length===0)throw new Error("deep-queries need at least one move path : "+t);if(r.length===0)break;r=this.analyseSelector(r,n);if(r.length===0)break;r[0]=="?"&&(r=this.analyseRQL(r,n))}var i=this;return n.length>0&&n[n.length-1].slashes=="/"&&n.push({type:"selector",value:"*",handler:function(e){return i.returnAllProps(e)}}),n},o.prototype.analyseRQL=function(t,r){if(t[0]!="?")return t;t=t.substring(1);if(t[0]=="("){var s=i(t);return r.push({type:"rql",value:s.value,handler:function(e){return u(e,s.value)}}),s.rest}var o=0,u="";while(t[o]!="/"&&o<t.length)u+=t[o++];return r.push({type:"rql",value:u,handler:function(e){var t=null;try{t=n(e,u)}catch(r){return console.log("deep-query : rql errors : ",r),[]}return t}}),t.substring(o)},o.prototype.analyseIndexAccess=function(t,n){var r="",i=0;while(t[i]!="/"&&t[i]!="?"&&i<t.length)r+=t[i++];var s=r.split(":"),o=this,u={type:"selector",handler:function(e){var t=this.start(e);if(t==-1)return[];var n=null;if(this.end===null)return n=o.returnProperty(e,t),n!==null&&typeof n!="undefined"?[n]:[];var r=[];for(var i=t;i<=this.end(e);i+=this.step(e))n=o.returnProperty(e,i),n!==null&&typeof n!="undefined"&&r.push(n);return r},start:null,end:null,step:function(e){return 1}},a=0,f=null;return s.forEach(function(e){if(e==="")a===0?f=function(e){return 0}:a==1?f=function(e){return e.value.length!==undefined?e.value.length-1:-1}:f=function(e){return 1};else if(e.substring(0,8)=="@.length"){var r=e.substring(8);if(r.length===0||r[0]!="-")throw new Error("DeepQueryError : when you use @.length : you could only use minus '-' operator followed by an integer. "+t+" - "+n.join(","));var i=parseInt(r.substring(1));if(isNaN(i))throw new Error("DeepQueryError : when you use @.length : you could only use minus '-' operator followed by an integer. "+t+" - "+n.join(","));f=function(e){return e.value.length!==undefined?e.value.length-i:-1}}else{var s=parseInt(e);if(isNaN(s))throw new Error("DeepQueryError : bad index : index unknown. "+t+" - "+n.join(","));f=function(e){return s}}a===0?u.start=f:a==1?u.end=f:u.step=f,a++}),n.push(u),t.substring(i)},o.prototype.analyseUnionAccess=function(t,n){if(t[0]!="[")throw new Error("DeepQueryError : union access need to start with '['. "+t+" - "+n.join(","));var r="",i=this,s=1;while(t[s]!="]"&&s<t.length)r+=t[s++];var o=r.split(","),u=this;if(o.length===0)return n.push({type:"selector",value:"*",handler:function(e){return u.returnAllProps(e)}}),t.substring(s+1);var a={type:"selector",selectors:[],handler:function(e){var t=[];return this.selectors.forEach(function(n){var r=n.handler(e);r&&(t=t.concat(r))}),t}};return o.forEach(function(e){i.analyseSelector(e,a.selectors,!0)}),n.push(a),t.substring(s+1)},o.prototype.returnProperty=function(e,n){if(typeof e.value=="string"&&n!=="length")return null;var r=e.value;return r&&typeof r[n]!="undefined"?e=t.create(n,e):e=null,e},o.prototype.returnAllProps=function(e){if(typeof e.value=="string")return[];var n=e.value,r=[];for(var i in n){if(i=="_deep_shared_")continue;if(!n.hasOwnProperty(i))continue;var s=t.create(i,e);typeof s!="undefined"&&r.push(s)}return r},o.prototype.returnRecursiveProps=function(e){if(typeof e.value=="string")return[];var n=e.value,r=[],i=this;for(var s in n){if(!n.hasOwnProperty(s))continue;var o=t.create(s,e);typeof o!="undefined"&&r.push(o),typeof n[s]=="object"&&(r=r.concat(i.returnRecursiveProps(o)))}return r},o.prototype.analyseSelector=function(e,t,n){var r=0,i=this;if(e.length===0)return t.length>1&&t[t.length-1].slashes=="//"?e:(n?t.push({type:"selector",value:"*",handler:function(e){return i.returnAllProps(e)}}):t.push({type:"selector",value:"*",handler:function(e){return i.returnAllProps(e)}}),e);if(e[0]=="?"){if(n)throw new Error("you couldn't write '?' in union of selectors. "+e+" - "+t.join(","));return t[t.length-1].slashes=="//"?e:(t.push({type:"selector",value:"*",handler:function(e){return i.returnAllProps(e)}}),e)}if(e[0]=="!")return t.push({type:"selector",value:"!",handler:function(e){return e?[e]:[]}}),e.substring(1);if(e[0]=="(")return this.analyseEreg(e,t);if(/^[0-9]/.test(e[0])||e[0]=="@"||e[0]==":")return this.analyseIndexAccess(e,t);if(e[0]=="["){if(n)throw new Error("DeepQueryError :  you couldn't have union in union of selectors. "+this.currentQuery);return this.analyseUnionAccess(e,t)}var s="";while(e[r]!="/"&&e[r]!="?"&&r<e.length)s+=e[r++];return s=="*"?t.length>0&&t[t.length-1].slashes=="//"?e.substring(r):(t.push({type:"selector",value:"*",handler:function(e){return i.returnAllProps(e)}}),e.substring(r)):(t.push({type:"selector",value:s,handler:function(e){var t=i.returnProperty(e,s);return t!==null&&typeof t!="undefined"?[t]:[]}}),e.substring(r))},o.prototype.analyseMoves=function(e,t){var n=[],r="",i=0;while(i<e.length&&(e[i]=="."||e[i]=="/")){while(e[i]=="/")r+="/",i++;if(r.length>0){if(r.length>2)throw new Error("DeepQueryError : bad move : "+e);n.push(r),r=""}while(e[i]==".")r+=".",i++;if(r.length>0){if(r.length>3)throw new Error("DeepQueryError :bad move : "+e);n.push(r),r=""}}var s=n[n.length-1];if(!s)throw new Error("DeepQueryError : missformed query : "+this.asked);s[0]=="."&&(i-=s.length);while(n.length>0){var o={type:"move",points:null,slashes:null},u=n.shift();u[0]=="."&&(o.points=u,u=n.shift());if(u!="/"&&u!="//")throw new Error("DeepQueryError : bad move : "+JSON.stringify(e)+" - "+u);o.slashes=u,t.push(o)}return e.substring(i)},o.prototype.doMove=function(e,t){var n=[],r=e,i=this;return t.forEach(function(e){if(r.points)switch(r.points){case".":n.push(e);break;case"..":e.ancestor&&n.push(e.ancestor);break;case"...":var t=e;while(t.ancestor)n.push(t.ancestor),t=t.ancestor;break;default:throw new Error("DeepQueryError : bad move : "+r)}else n.push(e);r.slashes=="//"&&(n=n.concat(i.returnRecursiveProps(e)))}),n};var u=/(\?)|(\/\/)|(\[)|(\()|(\*)/gi;o.prototype.query=function(e,n,i){if(typeof e!="object"||!e)return[];this.currentQuery=n,i=i||{};var o=null,a=null;n[0]==="#"&&(n=n.substring(1)),e._deep_query_node_?(a=e.root||e,n[0]=="/"?o=[a]:o=[e]):(a=t.root(e,i.schema),o=[a]);if(n=="/")return i.allowStraightQueries!==!1?i.fullOutput?o[0]:o[0].value:i.fullOutput?o:o.map(function(e){return e.value});this.straightQuery=!1,i.allowStraightQueries!==!1&&!n.match(u)&&(this.straightQuery=!0);var f;s[n]?f=s[n]:s[n]=f=this.analyse(n);if(f.length===0||f[0].type!="move")throw new Error("DeepQueryError : query need to start with move : "+n);var l=this,c=!0,h=1,p=f[0];while(p){switch(p.type){case"move":if(c&&p.slashes=="/"&&!p.points){o=[a];break}o=l.doMove(p,o);break;case"selector":var d=[],v=o.length;for(var m=0;m<v;++m){var g=o[m],y=p.handler(g);y&&y.length>0&&(d=d.concat(y))}o=d;break;case"rql":o=p.handler(o)}c=!1,p=f[h++]}o=r.arrayUnique(o,"path");if(i.fullOutput)return this.straightQuery?o.length==1?o.shift():undefined:(o._deep_array_=!0,o);var b=o.map(function(e){return e.value});return this.straightQuery?o.length==1?b.shift():undefined:b};var a=null;return o.query=function(e,t,n){return a||(a=new o),a.query(e,t,n)},o.remove=function(e,t,n){function i(e){if(!e.ancestor)return;r.push(e),e.ancestor.value instanceof Array?e.ancestor.value.splice(e.key,1):delete e.ancestor.value[e.key]}var r=[],s=o.query(e,t,{fullOutput:!0,schema:n});return s?s._deep_query_node_?(i(s),r.shift()):(s.forEach(i),r):s},o.replace=function(e,t,n,r){function s(e){if(!e.ancestor)return;e.ancestor.value[e.key]=e.value=n,i.push(e)}var i=[],u=o.query(e,t,{fullOutput:!0,schema:r});return u?u._deep_query_node_?(s(u),i.shift()):(u.forEach(s),i):u},t.find=function(e,t,n){t[0]==="?"&&(t="./*"+t),n=n||{},n.fullOutput=!0;var i;if(e._deep_array_){var s=null;t[0]=="/"&&(e.some(function(e){return s=e.root,s}),s&&(e=s));if(!s)return i=[],e.forEach(function(e){i=i.concat(o.query(e,t,n))}),i.length&&(i=r.arrayUnique(i,"path")),i._deep_array_=!0,i}return i=o.query(e,t,n),i._deep_query_node_?i:(i._deep_array_=!0,i)},o}),define("deepjs/lib/nodes",["require","deep-nodes/index","deep-utils/lib/interpret","deep-compiler/index","deep-nodes/lib/query","./promise"],function(e,t,n,r,i,s){return t.interpret=function(e,r,i){return t[i?"transform":"map"](e,function(e){return e?n.interpret(e._deep_query_node_?e.value:e,r):e})},t.up=function(){var e=Array.prototype.slice.call(arguments);return t.transform(e[0],function(t){return t?t._deep_query_node_?(e[0]=t.value,r.up.apply(r,e)):r.up.apply(r,e):t})},t.bottom=function(){var e=Array.prototype.slice.call(arguments),n=e.shift();return e.push(n),t.transform(n,function(t){return t?t._deep_query_node_?(e[e.length-1]=t.value,r.bottom.apply(r,e)):(e[e.length-1]=t,r.bottom.apply(r,e)):t})},t.transform=function(e,t){if(!e)return t(e);if(e.forEach){var n=[];return e.forEach(function(r,i){var o=s.when(t(r)).done(function(t){r._deep_query_node_?r.set(t):e[i]=t});n.push(o)}),s.all(n).when(e)}return s.when(t(e)).done(function(t){return e._deep_query_node_?e.set(t):t})},t}),define("deep-nodes/lib/traversal",["require","../index"],function(e,t){"use strict";var n={},r=function(e,t,n){if(e.paths.length===0){n.push(e),t._deep_node_=e,e.childs=[],e.hierarch=null;return}var r=e.paths.length-1,i=t,s=t._deep_node_||null;for(var o=0;o<r;++o){var u=e.paths[o],a=i[u];a||(i[u]=a={}),a._deep_node_&&(s=a._deep_node_),i=a}var f=i[e.key]={_deep_node_:e};e.hierarch=s,e.childs=[],s?s.childs.push(e):n.push(e)},i=function(e,t){return t.inArray?function(n){if(n&&n[t.inArray]){var r={},i=n[t.inArray],s=i.length;for(var o=0;o<s;++o)r[i[o]]=!0;if(e(r))return!0}return!1}:e};n.depthFirst=function(e,s,o,u){o=o||{},typeof s=="string"&&(s=n.parseSelector(s));if(s&&s.forEach){var a=0,f=0,l,c=[e],h;while(l=s[a++]){var p=[];while(h=c[f++])p=p.concat(n.depthFirst(h,l,o));f=0,c=p}return c}var d=[],v=null,m=null,g=o.hierarchy?{}:null;s&&(s=i(s,o)),e._deep_stack_?m=e.stack:(e._deep_query_node_||(e=t.root(e)),m=[e]);var y=e.depth;while(m.length>0){v=m.pop();if(u&&u[v.path])continue;var b=v.value;if(!b)continue;if(!o.minDepth||o.minDepth&&o.minDepth<=v.depth-y)if(s){if(s(b))if(o.hierarchy)r(v,g,d);else{if(o.first)return o.returnStack?{stack:m,result:v,_deep_stack_:!0,depth:y}:v;d.push(v)}}else d.push(v);var w=typeof b,E;if(w==="function"||w!=="object"&&w!=="function")continue;var p=[];if(b.forEach)for(var S=0,x=b.length;S<x;++S){E=b[S],w=typeof E;if(o.excludeLeafs&&w!=="object"&&w!=="function"||typeof jQuery!="undefined"&&E instanceof jQuery)continue;p.unshift(t.create(S,v))}else for(var T in b){E=b[T],w=typeof E;if(o.excludeLeafs&&w!=="object"&&w!=="function"||typeof jQuery!="undefined"&&E instanceof jQuery)continue;p.unshift(t.create(T,v))}m=m.concat(p)}return o.first&&d.length===0?[]:d},n.breadthFirst=function(e,s,o,u){o=o||{},typeof s=="string"&&(s=n.parseSelector(s));if(s&&s.forEach){var a=0,f=0,l,c=[e],h;while(l=s[a++]){var p=[];while(h=c[f++])p=p.concat(n.breadthFirst(h,l,o));f=0,c=p}return c}var d=[],v=null,m=null,g=o.hierarchy?{}:null;s&&(s=i(s,o)),e._deep_stack_?m=e.stack:(e._deep_query_node_||(e=t.root(e)),m=[e]);while(m.length>0){v=m.shift();if(u&&u[v.path])continue;var y=v.value;if(!y)continue;if(!o.minDepth||o.minDepth&&o.minDepth<=v.depth-firstDepth)if(s){if(s(y)){if(o.first)return o.returnStack?{stack:m,result:v,_deep_stack_:!0}:v;o.hierarchy?r(v,g,d):d.push(v)}}else d.push(v);var b=typeof y,w;if(b!=="object"&&b!=="function")continue;if(y.forEach)for(var E=0,S=y.length;E<S;++E){w=y[E],b=typeof w;if(o.excludeLeafs&&b!=="object"&&b!=="function"||typeof jQuery!="undefined"&&w instanceof jQuery)continue;m.push(t.create(E,v))}else for(var x in y){w=y[x],b=typeof w;if(o.excludeLeafs&&b!=="object"&&b!=="function"||typeof jQuery!="undefined"&&w instanceof jQuery)continue;m.push(t.create(x,v))}}return o.first&&d.length===0?null:d};var s={};return n.parseSelector=function(e){if(s[e])return s[e];var t=e[0],n=[],r="",i=0;while(t)switch(t){case"|":case"&":case"(":case")":case" ":case"!":r+=t,t=e[++i];break;case">":n.push(r),t=e[++i],r="";break;default:r+="value.";var o=i,u=!1;while(t){var a=!1;switch(t){case"|":case"&":case"(":case")":case">":case"!":a=!0;break;case"=":r+=e.substring(i,o+1)+"==",i=o+1}if(a){r+=e.substring(i,o),i=o;break}t=e[++o],t||(r+=e.substring(i,o))}}return r=r.replace("&","&&").replace("|","||").replace("value.this","value"),r.length>0&&n.push(r),n=n.map(function(e){return e!=="value.*"&&e!==""?new Function("value","return "+e+";"):function(){return!0}}),s[e]=n,n},n}),define("deep-nodes/lib/chained-api",["require","../index"],function(e,t){var n={transform:function(e){return this.done(function(n){return t.transform(n,e)})},map:function(e){return this.done(function(n){return t.map(n,e)})},each:function(e){return this.done(function(n){return t.each(n,e)})},run:function(e,t){var n=this;t=t||[],e&&e.forEach&&(t=e,e=null),t.forEach||(t=[t]);var r=function(n){var r=typeof e;if(!!e){if(r==="function")return n._deep_query_node_?e.apply(n.value,t):e.apply(n,t);if(r==="string"){var i=n;return n._deep_query_node_&&(i=n.value),i[e]?i[e].apply(i,t):n}return n._deep_query_node_?n.value:n}if(n._deep_query_node_){if(typeof n.value!="function")return;return n.ancestor?n.ancestor.value[n.key].apply(n.ancestor.value,t):n.value.apply({},t)}if(typeof n=="function")return n.apply({},t)};return n.done(function(e,t){if(!e)return e;if(e._deep_array_){var n=[];for(var i=0,s=e.length;i<s;++i)n.push(r(e[i]));return deep.all(n)}return r(e)})},sheet:function(){var e=Array.prototype.slice.call(arguments);return this.done(function(n){if(!t.sheet)throw new Error("Please load deep-sheets library before using .sheet somewhere.");return t.sheet(n,e)})},bottom:function(){var e=Array.prototype.slice.call(arguments);return this.done(function(n){return e.unshift(n),t.bottom.apply(t,e)})},up:function(){var e=Array.prototype.slice.call(arguments);return this.done(function(n){return e.unshift(n),t.up.apply(t,e)})},flatten:function(e){return this.done(function(n){return t.flatten(n,e)})},interpret:function(e,n){return this.done(function(r){return typeof r!="string"?r:t.interpret(r,e,n)})},find:function(e,n){return this.done(function(r){var i=t.find(r,e,n);return typeof i=="undefined"?{_deep_undefined_:!0}:i})},deepLoad:function(e,n,r){return this.done(function(i){return t.deepLoad(i,e,n,r)})}};return n}),define("deep-nodes/lib/dq-protocol",["require","./query"],function(e,t){return{get:function(e,n){n=n||{},n.keepCache=!1;var r=n.entry;if(!r)return null;var i=r.root||r,s=e;e._deep_request_&&(s=e.uri),s[0]=="#"&&(s=s.substring(1));var o=null;return s.substring(0,3)=="../"?(s=(r.path!="/"?r.path+"/":"")+s,o=t.query(i,s,n)):s[0]=="/"?o=t.query(i,s,n):o=t.query(r,s,n),o}}}),define("deep-sheets/index",["require","deep-protocols/index","deep-promise/index","deep-nodes/index","deep-nodes/lib/dq-protocol"],function(e,t,n,r,i){t.protocols.dq=i;var s={},o=function(e,t,n){return typeof t!="function"?new Error("SheetError : You try to apply sheets with something that's not a function."):t.call(this,e,n)},u=function(e,n,r){var i=t.parseRequest(n),u=i.protocol+"::"+i.uri,a=e[n],f=o,l=null;if(i.method!=="get"){f=s.methods?s.methods[i.method]:null;if(!f)throw new Error("SheetError : you try to apply sheets with unknown method : "+i.method)}return this.when(t.get(u,r)).done(function(e){if(e)return f.call(r.bind,e,a,r)})},a=function(e,t,r){if(typeof t=="function")return n.when(t(e,r)).when(e);var i=Object.keys(t),s=function(e){var n=i.shift();return n=="_deep_sheet_"&&(n=i.shift()),n?u.call(this,t,n,r).done(s):e};return n.when(e).done(s).elog("sheet application error").when(e)};return s.sheet=function(){var e=arguments[0],t;if(arguments.length>2){var n=Array.prototype.slice.call(arguments);n.shift();var r=function(e){return n.length?(this.done(r),s.sheet(e,n.shift())):e};return s.sheet(e,n.shift()).done(r).elog("sheet application error")}t=arguments[1];var i=i||{};return i.entry=e,i.fullOutput=!0,i.bind=i.bind||{},a(e,t,i)},r.sheet=function(e,t){if(e.forEach){var r=[];return e.forEach(function(e){r.push(s.sheet.apply(s,[e].concat(t)))}),n.all(r).when(e)}return s.sheet.apply(s,[e].concat(t))},s.methods={up:function(e,n,i){return t.getAll(n).done(function(t){return r.up.apply(r,[e].concat(t))})},bottom:function(e,n,i){return t.getAll(n).done(function(t){return r.bottom.apply(r,[e].concat(t))})}},s}),define("deep-flatten/index",["require","deep-nodes/index","deep-nodes/lib/traversal","deep-promise/index","deep-compiler/index","deep-sheets/index","deep-protocols/index"],function(e,t,n,r,i,s,o){function a(e,n){var r=n[0],s=0,o,u=[];while(r){o=[];while(r&&!r._deep_sheet_&&typeof r!="function")r._transformations&&(u=u.concat(r._transformations)),o.unshift(r),r=n[++s];o.length>0&&e.done(function(e){return e.value=i.upFromArgs(e.value,o,{excludeGrounds:!0}),e});if(!r)break;var a=[];while(r&&(r._deep_sheet_||typeof r=="function"))a.push(r),r=n[++s];e.done(function(e){var n=e.value;return!n||!a.length?e:(this.done(function(t){return t&&(t._deep_query_node_?e.value=t.value:e.value=t),e}),a.unshift(e),t.sheet.apply(t,a))})}return u}var u={},f=function(e,t){var n=[],i=!1,s=e.length;for(var u=0;u<s;++u){var a=e[u],f;if(!a)continue;if(typeof a=="string"){f=o.get(a,{entry:t}),n.push(f),f&&f.then&&(i=!0);continue}a._backgrounds&&(f=l(a._backgrounds,t),n.push(f),f&&f.then&&(i=!0)),a._foregrounds&&(f=l(a._foregrounds,t),n.push(f),f&&f.then&&(i=!0))}if(!n.length)return e;var c=function(t){var n=[];for(var r=0;r<s;++r){var i=e[r];i&&i._backgrounds&&(n=n.concat(t.shift())),typeof i=="string"?n.push(t.shift()):n.push(i),i&&i._foregrounds&&(n=n.concat(t.shift()))}return n};return i?r.all(n).done(c):c(n)},l=function(e,t){var n=[],i=!1;return e.forEach(function(e){if(typeof e=="string"){var r=o.get(e,{entry:t});r&&r.then&&(i=!0),n.push(r)}else n.push(e)}),i?r.all(n).done(function(e){return f(e,t)}):f(n,t)},c=function(e){return e._backgrounds||e._foregrounds||e._deep_flattener_||e._transformations},h={first:!0,returnStack:!0,excludeLeafs:!0,minDepth:1},p=function(e,t,r){t=n.depthFirst(t||e,c,h,r);if(!t)return e;var i=t.result;if(!i)return e;i.post_actions=e.post_actions;var s;return i.value._deep_flattener_?s=i.value.flatten(i).when(e):s=u.flatten(i),s&&s.then?s.done(function(){return p(e,t,r)}):p(e,t,r)},d=function(e){e._deep_query_node_||(e=t.root(e));var n=[],i=e.value,s,o;return i._backgrounds&&(s=f(i._backgrounds,e),n.push(s),s&&s.then&&(o=!0)),i._foregrounds&&(s=f(i._foregrounds,e),n.push(s),s&&s.then&&(o=!0)),o?r.all(n):r.immediate(n)},v=function(e){var t=e.value;return d(e).done(function(n){return t._backgrounds&&(delete t._backgrounds,e.value=t._deep_sheet_?null:{},e.transformations=a(this,n.shift()),this.done(function(e){return e.value?e.value=i.abottom(e.value,t,{excludeGrounds:!0}):e.value=t,e})),e.transformations=e.transformations||[],t._transformations&&(e.transformations=e.transformations.concat(t._transformations),delete t._transformations),t._foregrounds&&(delete t._foregrounds,e.transformations=e.transformations.concat(a(this,n.shift()))),e}).done(function(e){var t=e.value;return delete t._transformations,delete t._backgrounds,delete t._foregrounds,e.transformations&&e.transformations.length&&e.post_actions.push(e),e.set(t),e})};return u.extendsGrounds=d,u.flatten=function(e,n){if(!e)return r.immediate(e);if(n){var i={};for(var s=0,o=n.length;s<o;++s)i[n[s]]=!0;n=i}var u=!1;e._deep_query_node_||(u=!0,e=t.root(e));var a=!1;e.post_actions||(a=!0,e.post_actions=[]);var f;return e.value&&e.value._deep_flattener_?f=e.value.flatten(e).when(e):(f=r.when(v(e)).done(function(e){return p(e,null,n)}),a&&f.done(function(n){for(var r=0,i=e.post_actions.length;r<i;++r){var s=e.post_actions[r];s.transformations&&s.transformations.length&&t.sheet(s,s.transformations)}})),f.done(function(t){return u?e.value:e}),f},t.flatten=function(e,t){if(!e)return r.immediate(e);if(e._deep_array_){var n=[];return e.forEach(function(e){if(!e.value||typeof e.value!="object")return;n.push(u.flatten(e,t))}),n.length===0?r.immediate(e):r.all(n).done(function(){return e})}return u.flatten(e,t)},u}),define("deep-ocm/index",["require","deep-utils/index","deep-promise/index","deep-flatten/index","deep-compiler/index","deep-modes/index"],function(e,t,n,r,i,s){var o=Array.prototype.slice,u=function(e,a){a=a||{};var f={nocache:a.nocache||!1,sensibleTo:a.sensibleTo||null,flattened:a.flattened||!1,strict:a.strict||!1,layer:e||{},currentModes:a.modes||null,compiled:{},multiModes:typeof a.multiModes!="undefined"?a.multiModes:!0,afterCompilation:a.afterCompilation||null,compile:function(e,t){var n=this,r=null,s=[];if(this.multiModes===!1&&e.length>1)return r;var o=e.every(function(e){var t=n.layer[e];return typeof t=="undefined"?n.strict?!1:!0:(r&&t&&t._deep_sheet_&&u.applySheet?u.applySheet(r,t):r=i.up(r,t),!0)});return o?r:undefined}},l=function(e,t){var r;return(n.Promise.context.modes&&(r=n.Promise.context.modes[e])||(r=s.Modes(e)))&&!0,r===!0?t.concat(e):r?t.concat(r):t},c=function(){var e=o.call(arguments);if(e.length===0)if(f.currentModes&&f.currentModes.length>0)e=f.currentModes;else if(f.sensibleTo)if(f.sensibleTo.forEach)for(var t=0,n=f.sensibleTo.length;t<n;++t)e=l(f.sensibleTo[t],e);else e=l(f.sensibleTo,e);if(!e||e.length===0)throw new Error("OCMError : You need to set a mode before using ocm objects.");e.forEach||(e=[e]);var r=e.join(".");if(typeof f.compiled[r]!="undefined")return f.compiled[r];var i=f.compile(e,f.layer);return!u.nocache&&!f.nocache&&(f.compiled[r]=i),f.afterCompilation?f.afterCompilation(i)||i:i};return c._deep_ocm_=!0,c._deep_compiler_=!0,c._deep_flattener_=!0,c.multiModes=function(e){f.multiModes=e},c.sensibleTo=function(e){return f.blocked?c:(f.sensibleTo=e,c)},c.layer=function(){return f.layer},c.modes=c.mode=function(e){return f.blocked?c:(e===null?f.currentModes=null:f.currentModes=o.call(arguments),c)},c.flatten=function(e,t){if(!t&&f.flattened)return f.flattened.then?n.when(f.flattened):n.immediate(c);f.compiled={},e&&e.set(f.layer);var i=f.flattened=new n.Promise;return n.when(r.flatten(e||f.layer)).done(function(t){t&&t._deep_query_node_?f.layer=t.value:f.layer=t,f.flattened=!0,e&&e.set(c),i.resolve(c)}).fail(function(t){e&&e.set(c),i.reject(t)}),i},c._up=function(){f.flattened=!1;for(var e=0;e<arguments.length;++e)f.layer=i.up(f.layer,arguments[e]);return f.layer},c._bottom=function(){f.flattened=!1;for(var e=0;e<arguments.length;++e)f.layer=i.bottom(f.layer,arguments[e]);return f.layer},c._clone=function(){var e=null;return a.flattened=f.flattened,typeof protocol=="string"?e=u(t.copy(f.layer),a):e=u(t.copy(f.layer),a),e.multiModes(f.multiModes),f.currentModes&&e.modes(f.currentModes),e},c};return u.nocache=!1,u}),define("deep-utils/lib/errors",[],function(){var e={toString:function(){var e="Error : "+this.status+" - "+this.message;return this.report&&(this.report.toString?e+=this.report.toString():e+=" - report : "+JSON.stringify(this.report)),e},Error:function(e,t,n,r,i){var s=new Error(t,r,i);return s.status=e,s.report=n,s},MethodNotAllowed:function(e,t,n,r){return this.Error(405,e||"MethodNotAllowed",t,n,r)},Internal:function(e,t,n,r){return this.Error(500,e,t,n,r)},PreconditionFail:function(e,t,n,r){return this.Error(412,e||"PreconditionFail",t,n,r)},NotFound:function(e,t,n,r){return this.Error(404,e||"NotFound",t,n,r)},Forbidden:function(e,t,n,r){return this.Error(403,e||"Forbidden",t,n,r)},Range:function(e,t,n,r){return this.Error(416,e||"Range",t,n,r)},Conflict:function(e,t,n,r){return this.Error(409,"ConflictError : "+e,t,n,r)},Unsupported:function(e,t,n,r){return this.Error(415,"UnsupportedMediaTypeError : "+e,t,n,r)},NotAcceptable:function(e,t,n,r){return this.Error(406,"NotAcceptableError : "+e,t,n,r)},Unauthorized:function(e,t,n,r){return this.Error(401,"UnauthorizedError : "+e,t,n,r)}};return e}),define("deepjs/lib/validator",["require"],function(e){var t=null;return{set:function(e){t=e},validate:function(e,n){if(!t)throw new Error("no real schema validator setted. please set on using (deepjs/lib/validator).set");return t.validate(e,n)},partialValidation:function(e,n,r){if(!t)throw new Error("no real schema validator setted. please set on using (deepjs/lib/validator).set");return t.partialValidation(e,n,r)}}}),define("deepjs/lib/deepequal",[],function(){var e=function(t,n,r){r===undefined&&(r=!0);var i=typeof t;if(i!==typeof n)return!1;if(t&&i==="object"){if(!n)return!1;if(t._deep_promise_)return n._deep_promise_?!0:!1;var s=!0,o=[],u=[];if(typeof t.forEach=="function"){if(typeof n.forEach!="function"||t.length!==n.length)return!1;var a=0;s=s&&t.every(function(t){return e(t,n[a++])});if(!s)return!1}else{for(var f in n){if(typeof t[f]=="undefined")return!1;s=s&&e(t[f],n[f]);if(!s)return!1;u.push(f)}for(var f in t)o.push(f)}if(o.length!==u.length)return!1;if(r)for(var l=0;l<u.length;++l)if(u[l]!==o[l])return!1}else if(t!==n)return!1;return!0};return e}),define("deepjs/lib/emitter",["require","./promise"],function(e,t){var n={};return n.Event=function(e,t,n){this.datas=t||null,this.type=e},n.Emitter=function(){var e={};this.emit=function(r,i,s){var o=e[r],u;if(!o)return;s&&(u=t.Promise.context,u&&u.suspend&&u.suspend(),t.Promise.context=s,s.resume&&s.resume());for(var a=0,f=o.length;a<f;++a)o[a](new n.Event(r,i));s&&(s.suspend&&s.suspend(),u&&u.resume&&u.resume(),t.Promise.context=u)},this.on=function(t,n){e[t]=e[t]||[],n._deep_listener_index_=e[t].length,e[t].push(n)},this.remove=function(t,n){var r=e[t];if(!r)return;r.splice(n._deep_listener_index_,1)}},n}),define("deepjs/lib/logs",["require","deep-utils/index","./promise"],function(e,t,n){var r={},i={slog:function(e,t,n){e.length===0&&e.push("dp:success : ");var r=t;if(t&&t._deep_query_node_)r=t.value;else if(r&&r._deep_array_){e.push("("+r.length+" node(s)) : \n\n");var i=[],s=0;r.forEach(function(e){i.push(s++,": ",e.value),s<r.length&&i.push(",\n\n")}),i.length&&(e=e.concat(i))}return(!r||!r._deep_array_)&&e.push(r),console.log.apply?console.log.apply(console,e):console.log(e),t},elog:function(e,t,n){return e.length===0&&e.unshift("dp:error"),n.report?e.push("("+n.status+"): ",n.message,n.report):e.push("("+n.status+"): ",n.message),console.error.apply?console.error.apply(console,e):console.error(e),n},log:function(){return console.log.apply?console.log.apply(console,arguments):console.log(t.argToArr.call(arguments)),this},warn:function(){return console.warn.apply?console.warn.apply(console,arguments):console.warn(t.argToArr.call(arguments)),this},error:function(){return console.error.apply?console.error.apply(console,arguments):console.error(t.argToArr.call(arguments)),this},debug:function(){return n.Promise.context.debug?(console.log.apply?console.log.apply(console,arguments):console.log(t.argToArr.call(arguments)),this):this}},s=n.Promise;t.dumpError=function(e,t){var n=u();if(typeof e=="object"&&e!==null){if(e.dumped)return;n.warn("\n**** Error Dump ****"),t&&(t[0]==="dp:error"&&t.shift(),t.length&&t.forEach&&n.log(t.join?t.join(" - "):t)),e.status&&n.log("\nStatus: "+e.status),n.error(e),e.requireModules&&n.log("Error from : ",e.requireModules),e.stack&&(n.log("\nStacktrace:"),n.log("===================="),n.log(e.stack)),e.report&&(n.log("\nReport:"),n.log("===================="),n.log(JSON.stringify(e.report,null," ")),n.log("============================================================")),n.log("\n"),e.dumped=!0}else n.warn("dumpError :: argument is not an object : ",e)},t.logItemsProperty=function(e,t){var n=[];return e.forEach(function(e){u().log("deep.logItemsProperty : ",t,e[t]),n.push(e[t])}),n};var o={},u=function(){var e=(s.context?n.Promise.context.logger:null)||o.globalLogger||i;return e._deep_ocm_&&(e=e()),e};return r.setMain=function(e){return o.globalLogger=e,loger},r.slog=function(){var e=u();return e.slog.apply(e,arguments),this},r.elog=function(){var e=u();return e.elog.apply(e,arguments),this},r.log=function(){var e=u();return e.log.apply(e,arguments),this},r.debug=function(){if(n.Promise.context.debug){var e=u();e.log.apply(e,arguments)}return this},r.warn=function(){var e=u();return e.warn.apply(e,arguments),this},r.error=function(){var e=u();return e.error.apply(e,arguments),this},r}),define("deepjs/deep",["deep-compiler/index","deep-compiler/lib/classes","deep-compiler/lib/restrictions","deep-protocols/index","./lib/cache","./lib/promise","deep-modes/index","decompose/index","./lib/nodes","deep-nodes/lib/query","deep-nodes/lib/rql","deep-nodes/lib/traversal","deep-nodes/lib/chained-api","deep-ocm/index","deep-flatten/index","deep-sheets/index","deep-utils/index","deep-utils/lib/string","deep-utils/lib/errors","./lib/validator","./lib/deepequal","./lib/emitter","./lib/logs","deep-utils/lib/interpret"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S){function x(e,t){for(var n in e)t[n]=e[n]}var T={Classes:t,compose:u,Querier:f,rql:l,ocm:p,flatten:d.flatten,sheet:v.sheet,utils:m,cache:i,Arguments:u.Arguments,errors:y,query:f.query,isNode:typeof process!="undefined"&&process.versions&&process.versions.node};return m.nodes=a,m.deepEqual=w,x(s,T),x(e,T),x(n,T),x(r,T),x(c,T),x(o,T),x(g,m),x(E,T),x(S,T),delete T.setModesIn,T.context=function(e,t){return e?t?T.Promise.context[e]=t:T.Promise.context[e]:T.Promise.context},T.contextualise=function(e){return(new T.Promise).contextualise(e).fromContext().resolve()},a.equal=function(e,t){var n=e;return n&&(n._deep_query_node_||n._deep_array_)&&(n=a.val(e)),w(n,t)?e:T.errors.PreconditionFail("deep.equal failed ! ",{equal:!1,value:n,needed:t})},h.equal=function(e){return this.done(function(e){return a.equal(e,needed)})},T.Promise._up({equal:h.equal,modes:function(e,t){var n=this;return this.done(function(r,i){return n._contextualised||T.contextualisePromise(n),n._context.modes=n._context.modes||{},o.setModesIn(n._context.modes,e,t),r})}}),T.modes=function(e,t){return(new T.Promise).resolve(undefined).modes(e,t)},p.applySheet=T.sheet,t.applySheet=T.sheet,v.methods={up:function(e,t,n){return r.getAll(t).done(function(t){return a.up.apply(a,[e].concat(t))})},bottom:function(e,t,n){return r.getAll(t).done(function(t){return a.bottom.apply(a,[e].concat(t))})},map:function(e,t,n){return a.map(e,t)}},T.Validator=b,T.validate=b.validate,T.partialValidation=b.partialValidation,T}),define("deepjs/lib/nodes-composer",["require","../deep","deep-nodes/lib/chained-api"],function(e,t,n){return t.compose.nodes=t.compose.Composer(n),t.compose.nodes}),define("deepjs/lib/nodes-promise",["require","../deep","deep-nodes/lib/chained-api"],function(e,t,n){var r=t.NodesPromise=t.Classes(t.Promise,function(e,t){t=t||{};var n=t.obj,i=t.schema;(n||i)&&this._init(n,i),this._identity=r},{_init:function(e,t){e&&e._deep_query_node_?t&&(e.schema=t):(!e||!e._deep_array_)&&t&&(e=nodes.root(e,t)),this._state.success=e}},n);return t.nodes=r.start=function(e,n,i){i=i||{};var s=new r(i._state||null,i),o;try{typeof e=="string"&&(e=t.get(e,i)),typeof n=="string"&&(n=t.get(n,i)),!n&&e&&(e.then||e.promise)&&(o=t.when(e).done(function(e){s._init(e),s.resolve()})),n&&(n.then||n.promise)&&(e&&(e.then||e.promise)?o=t.all([e,n]).done(function(e){s._init(e[0],e[1]),s.resolve()}):o=t.when(n).done(function(e){s._init(null,e),s.resolve()})),o?o.fail(function(e){s.reject(e)}):(s._init(e,n),s.resolve())}catch(u){s.reject(u)}return s},t.Promise._up({nodes:function(e,t,n){n=n||{};var i=new r(this._state,n),s=this,o=function(i,s){return r.start(e||i,t,n)};return this._enqueue(i),i._enqueue(o,"done"),i}}),r}),require.config({baseUrl:"/statics/libs",paths:{}}),define("main-deepjs",["deepjs/deep","deepjs/lib/nodes-composer","deepjs/lib/nodes-promise"],function(e,t,n){return e});