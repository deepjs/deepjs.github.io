!function(e){"use strict";e([],function(){function e(e,t){"undefined"!=typeof t&&(t instanceof Error?(e._state.success=null,e._state.error=t):(t&&t._deep_undefined_&&(t=void 0),e._state.success=t,e._state.error=null)),e._running=!1,e._executing||e._next()}function t(e,t){e._running=!1,e._state.success=null,e._state.error=t,e._executing||e._next()}function r(r){r._executing=!0;for(var n=function(t){return e(r,t)},o=function(e){return t(r,e)};!r._running;){var i=r._state.queue.shift();if(r._state.error)for(;i&&"done"==i.type;)i=r._state.queue.shift();else for(;i&&"fail"==i.type;)i=r._state.queue.shift();if(!i)break;if(i.fn&&i.fn._deep_promise_){r._paused=!0,i.fn._context=r._context,i.fn.resolve();break}r._running=!0,r._state.oldQueue=r._state.queue,r._state.queue=[];var u=i.fn.call(r,r._state.success,r._state.error);if(u!==r){if(u&&"function"==typeof u.then){var c=u._deep_promise_||u._deep_chain_?u:s.when(u);c.done(n).fail(o)}else if(r._running=!1,"undefined"!=typeof u){var a;null!==u&&(u._deep_undefined_?(u=void 0,a=!1):a=u instanceof Error),r._state.success=a?null:u,r._state.error=a?u:null}r._state.oldQueue&&(r._state.queue.length?r._state.queue=r._state.queue.concat(r._state.oldQueue):r._state.queue=r._state.oldQueue,r._state.oldQueue=null)}else r._state.oldQueue&&(r._state.queue.length?r._state.queue=r._state.queue.concat(r._state.oldQueue):r._state.queue=r._state.oldQueue,r._state.oldQueue=null),r._running=!1}}function n(e){var t={};for(var r in e)t[r]=e[r];return t}var s={};s.Undefined={_deep_undefined_:!0},s.when=function(e){if(!e||!e.promise&&!e.then)return(new s.Promise).resolve(e);if(e._deep_deferred_)return e.promise();if("function"==typeof e.then){var t=new s.Promise;return e.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t}return"function"==typeof e.promise?e.promise():"object"==typeof e.promise?e.promise:(new s.Promise).resolve(e)},s.immediate=function(e){return(new s.Promise).resolve(e)},s.all=function(e){if(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),0===e.length)return s.immediate([]);var t=new s.Promise,r=e.length,n=0,o=-1,i=[];return e.every(function(e){if(t._rejected)return!1;var s=o+1;if(e&&e.then)e.then(function(e){i[s]=e,n++,n==r&&t.resolve(i)},function(e){t.ended()||t.reject(e)});else{if(e instanceof Error)return t.ended()||t.reject(e),!1;i[s]=e,n++,n==r&&t.resolve(i)}return o++,!0}),t},s.Deferred=function(){return this instanceof s.Deferred?(this._promises=[],this._deep_deferred_=!0,this):new s.Deferred},s.Deferred.prototype={_deep_deferred_:!0,_promises:null,rejected:!1,resolved:!1,canceled:!1,_success:null,_error:null,ended:function(){return this.rejected||this.resolved||this.canceled},resolve:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");if(e instanceof Error)return this.reject(e);this._success=e,this.resolved=!0;this._promises.forEach(function(t){t.resolve(e)})},reject:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");this._error=e,this.rejected=!0;this._promises.forEach(function(t){t.reject(e)})},promise:function(){var e=new s.Promise;return this.resolved?e.resolve(this._success):this.rejected?e.reject(this._error):(this._promises.push(e),e)}};var o=s.Promise=function(e,t){this._state=e=e||{},this._context=e.context||s.Promise.context,this._state.success=e.success||void 0,this._state.error=e.error||null,this._state.queue=e.queue||[],this._state.oldQueue=e.oldQueue||null,this._state.handlers=e.handlers||[],this._state.handlers.push(this),this._identity=s.Promise};return o.prototype={_locals:void 0,_deep_promise_:!0,_running:!1,_executing:!1,_initialised:!1,_resolved:!1,_rejected:!1,_enqueue:function(e,t){return this._state.queue.push({fn:e,type:t}),!this._initialised||this._running||this._executing||this._next(),this},_next:function(){if(this._initialised&&!this._paused){var e,t=this;if(0!==t._state.queue.length){try{e=s.Promise.context,e!==t._context&&(e&&e.suspend&&e.suspend(),s.Promise.context=t._context,t._context&&t._context.resume&&t._context.resume()),r(t)}catch(n){if(t._context.debug&&(s.Promise.dumpError?s.Promise.dumpError(n):console.error(n)),t._state.success=null,t._state.error=n,t._running=!1,t._context.rethrow)throw n}finally{e!==t._context&&(t._context&&t._context.suspend&&t._context.suspend(),e&&e.resume&&e.resume(),s.Promise.context=e)}t._executing=!1}}},ended:function(){return this._resolved||this._rejected},resolve:function(e){if(this.ended())throw new Error("promise already resolved or rejected");this._resolved=!0,this._paused=!1,this._initialised=!0,"undefined"!=typeof e&&(this._state.success=e);var t=this._state.success instanceof Error;return this._state.error=t?this._state.success:this._state.error,this._state.success=t?null:this._state.success,this._next(),this},reject:function(e){if(this.ended())throw new Error("promise already resolved or rejected");return this._rejected=!0,this._paused=!1,this._initialised=!0,this._state.error=e,this._next(),this},close:function(){return 1==this._state.handlers.length?this:(this._state.handlers.pop(),this._state.handlers[this._state.handlers.length-1])},clone:function(){return new this._identity({handlers:this._state.handlers.slice(),queue:this._state.queue?this._state.queue.slice():[],oldQueue:this._state.oldQueue?this._state.oldQueue.slice():null,success:this._state.success,error:this._state.error})},catchError:function(e){var t=this;return this.always(function(){t.toContext("rethrow",e?!0:!1)})},pushTo:function(e){var t=this;return t._initialised?this.always(function(){e.push(t)}):(e.push(t),this)},done:function(e){var t=this,r=function(r){if(!e)return r;var n=e.call(t,r);if(n!==t)return n};return t._enqueue(r,"done")},spread:function(e){var t=this,r=function(e){if(!callBack)return e;var r=callBack.apply(t,e&&e.forEach?e:[e]);if(r!==t)return r};return t._enqueue(r,"done")},fail:function(e){var t=this,r=function(r,n){if(!e)return n;var s=e.call(t,n);if(s!==t)return s};return t._enqueue(r,"fail")},always:function(e){var t=this,r=function(r,n){if(!e)return n||r;var s=e.call(t,r,n);if(s!==t)return s};return t._enqueue(r,"always")},then:function(e,t){var r=this;return e&&this.done(function(t){var n=e.call(r,t);if(n!==r)return n}),t&&this.fail(function(e){var n=t.call(r,e);if(n!==r)return n}),this},delay:function(e){return this.always(function(){var t=new s.Promise;return setTimeout(function(){t.resolve(void 0)},e),t})},toState:function(e,t){var r=this;return this.done(function(n){return e?(t="undefined"==typeof t?n:t,r._state[e]=t,t):new Error(".toState need key/val couple.")})},fromState:function(e){var t=this;return this.done(function(r){if(!e)return t._state;var n=t._state[e];return"undefined"==typeof n?deep.Undefined:n})},when:function(e){return this.done(function(){return e})}},s.promisify=function(e,t){return function(){var r=Array.prototype.slice.call(arguments),n=new n.Promise;return r.push(function(){var e=Array.prototype.slice.call(arguments),t=e.shift();t?n.reject(t):n.resolve(e.length<=1?e[1]:e)}),e.apply(t||{},r),n}},s.async=function(e,t,r){var n=new n.Promise,s=function(){var e=Array.prototype.slice.apply(arguments),t=e.shift();t?n.reject(t):n.resolve(e.length?1==e.length?e[0]:e:!0)};return r.push(s),e?"string"==typeof t?e[t].apply(e,r):t.apply(e,r):t.apply({},r),n},s.loop=function(e,t,r,n){var s=0,o=!1,i=function(n){return o?n:r&&(s++,s>r)?n:(this.done(e).delay(t).done(i),n)},u=(new prom.Promise).resolve(n).done(i);return u.finish=function(){o=!0},u},o.getLogger=function(){return s.Promise.context&&s.Promise.context.logger||s.Promise.logger||console},o.prototype.log=function(){var e=Array.prototype.slice.call(arguments);return this.elog.apply(this,e).slog.apply(this,e)},o.prototype.elog=function(){var e=Array.prototype.slice.call(arguments);return this.fail(function(t){var r=s.Promise.getLogger();e.push(t),r.error.apply(r,e)})},o.prototype.slog=function(){var e=Array.prototype.slice.call(arguments);return this.done(function(t){var r=s.Promise.getLogger();e.push(t),r.log.apply(r,e)})},o.context={rethrow:!1,debug:!0},s.contextualisePromise=function(e){return e._context=s.Promise.context=s.Promise.context?n(s.Promise.context):{},e._contextualised=!0,s.Promise.context},o.prototype.toContext=function(e,t){var r=this;return this.done(function(n){if(!e)return new Error(".toContext need key/val couple or an object as first argument.");if("object"==typeof e){for(var s in e)r._context[s]=e[s];return n}return t="undefined"==typeof t?n:t,r._context[e]=t,n})},o.prototype.contextualise=function(e){var t=this;return this.done(function(r){if(t._context=s.contextualisePromise(t),t._contextualised=!0,e)for(var n in e)t._context[n]=e[n];return r})},o.prototype.fromContext=function(e){var t=this;return this.done(function(){if(!e)return t._context;var r=t._context[e];return"undefined"==typeof r?s.Undefined:r})},o.prototype.clog=function(e){var t=this;return this.always(function(){e?s.Promise.getLogger().log("promise.context."+e+" : ",t._context[e]):s.Promise.getLogger().log("promise.context : ",t._context)})},o.prototype.debug=function(){var e=Array.prototype.slice.call(arguments);return this.always(function(t,r){if(s.Promise.context.debug){var n=s.Promise.getLogger();e.push(r||t),n.debug?n.debug.apply(n,e):n.log.apply(n,e)}})},s})}("undefined"!=typeof define?define:function(e,t){"undefined"!=typeof module?module.exports=t():promise=t()});